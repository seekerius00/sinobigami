<!DOCTYPE html>
<html lang="ja">
<head>

    <!--
    ä¿®æ­£ç‰ˆv5:
    1. ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã®åˆ‡æ›¿ãƒªãƒ³ã‚¯ã‚’å³å¯„ã›ã®ãƒœã‚¿ãƒ³ã«å¤‰æ›´
    2. åˆ¤å®šå€¤ã®è¡¨ç¤ºå½¢å¼ã‚’ã€Œ2D6>=X ï¼ˆä»£ç”¨åˆ¤å®šï¼šYYï¼‰ã€ç­‰ã«å¤‰æ›´
    -->
     
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚·ãƒãƒ“ã‚¬ãƒŸ Webãƒ„ãƒ¼ãƒ« (Firebase Server)</title>
    
    <!-- Firebase SDKs (v11.6.1) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, addDoc, doc, updateDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =================================================================
        // ã€é‡è¦ã€‘ã“ã“ã«ã‚ãªãŸã®Firebaseè¨­å®šæƒ…å ±ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„
        // =================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyDITm-Xg2nxtVKEW2ojmnNCMmji8vPdneA",
            authDomain: "sinobigami-7e0a8.firebaseapp.com",
            projectId: "sinobigami-7e0a8",
            storageBucket: "sinobigami-7e0a8.firebasestorage.app",
            messagingSenderId: "990756511964",
            appId: "1:990756511964:web:a5547a5d03c23118c3d419",
            measurementId: "G-QLH854BT56"
        };
        // =================================================================

        const appId = 'my-shinobigami-server';
        let app, auth, db;
        let dbUser = null;
        let firebaseReady = false;

        const USERS_COL = 'users';
        const CHARS_COL = 'characters';

        async function initApp() {
            updateStatus('connecting', 'ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šä¸­...');
            
            if (firebaseConfig.apiKey === "ã“ã“ã«API_KEYã‚’è²¼ã‚Šä»˜ã‘") {
                updateStatus('offline', 'è¨­å®šã‚¨ãƒ©ãƒ¼');
                alert("Firebaseè¨­å®šãŒå¿…è¦ã§ã™ã€‚ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                await signInAnonymously(auth);
                await ensureAdminExists();
                
                firebaseReady = true;
                updateStatus('online', 'ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šå®Œäº† (Online)');
                document.getElementById('loadingOverlay').style.display = 'none';
                
                const lastUser = localStorage.getItem('last_username');
                if(lastUser) document.getElementById('authUsername').value = lastUser;

                checkAuth();

            } catch (error) {
                console.error("Firebase Init Error:", error);
                updateStatus('offline', 'æ¥ç¶šã‚¨ãƒ©ãƒ¼');
                alert("ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼: " + error.message);
            }
        }
        
        function updateStatus(state, msg) {
            const el = document.getElementById('serverStatus');
            const txt = document.getElementById('serverStatusText');
            if(el) {
                txt.textContent = msg;
                el.className = 'status-indicator ' + state;
            }
        }

        async function ensureAdminExists() {
            //const adminUser = 'seekerius0017';
            //const adminPass = '123456789';
            try {
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', USERS_COL), where('username', '==', adminUser));
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', USERS_COL), {
                        username: adminUser,
                        password: adminPass,
                        role: 'admin',
                        createdAt: Date.now()
                    });
                }
            } catch (e) { console.warn("Admin check failed:", e); }
        }

        function checkAuth() {
            const hash = window.location.hash.substring(1).split('?')[0];
            if (hash === 'view') return;
            if (hash === 'login') return;
            if (!dbUser && (hash === 'edit' || hash === 'admin' || hash === 'list' || hash === '')) {
                window.location.hash = '#login';
            }
        }
        window.addEventListener('hashchange', checkAuth);

        window.app_rcreateUserWithEmailAndPasswordegister = async (username, password) => {
            if (!firebaseReady) return alert("ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šä¸­...");
            if (password.length < 6) return { success: false, message: "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§è¨­å®šã—ã¦ãã ã•ã„ã€‚" };
            try {
                const usersRef = collection(db, 'artifacts', appId, 'public', 'data', USERS_COL);
                const q = query(usersRef, where('username', '==', username));
                const snapshot = await getDocs(q);
                if (!snapshot.empty) return { success: false, message: "ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚" };
                
                await addDoc(usersRef, { 
                    username: username, 
                    password: password, 
                    role: 'user', 
                    createdAt: Date.now() 
                });
                return { success: true };
            } catch (e) { return { success: false, message: "ã‚¨ãƒ©ãƒ¼: " + e.message }; }
        };

        window.signInWithEmailAndPassword = async (username, password) => {
            if (!firebaseReady) return alert("ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šä¸­...");
            try {
                const usersRef = collection(db, 'artifacts', appId, 'public', 'data', USERS_COL);
                const q = query(usersRef, where('username', '==', username));
                const snapshot = await getDocs(q);
                if (snapshot.empty) return { success: false, message: "ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚" };
                
                const userDoc = snapshot.docs[0];
                const userData = userDoc.data();
                
                if (userData.password !== password) return { success: false, message: "ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚" };
                
                dbUser = { id: userDoc.id, ...userData };
                window.currentUser = dbUser;
                localStorage.setItem('last_username', username);
                
                return { success: true, role: userData.role };
            } catch (e) { return { success: false, message: "ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼" }; }
        };
        
        window.app_logout = () => {
            dbUser = null;
            window.currentUser = null;
            window.location.hash = '#login';
        };

        window.app_loadCharacters = async () => {
            if (!dbUser) return [];
            try {
                const colRef = collection(db, 'artifacts', appId, 'public', 'data', CHARS_COL);
                const q = query(colRef, where('owner', '==', dbUser.username));
                const snapshot = await getDocs(q);
                return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (e) { return []; }
        };

        window.app_saveCharacter = async (charId, data) => {
            if (!dbUser) return null;
            try {
                const colRef = collection(db, 'artifacts', appId, 'public', 'data', CHARS_COL);
                const savePayload = { ...data, owner: dbUser.username, updatedAt: Date.now() };
                delete savePayload.id; 
                
                if (charId) { 
                    await updateDoc(doc(colRef, charId), savePayload); 
                    return charId; 
                } else { 
                    const docRef = await addDoc(colRef, savePayload); 
                    return docRef.id; 
                }
            } catch(e) { throw e; }
        };

        window.app_getCharacter = async (charId) => {
            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', CHARS_COL, charId);
                const snap = await getDoc(docRef);
                if (!snap.exists()) return null;
                const data = snap.data();
                return { id: snap.id, ...data };
            } catch(e) { return null; }
        };

        window.app_deleteCharacter = async (charId) => {
            if (!dbUser) return;
             try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', CHARS_COL, charId)); } catch(e) { throw e; }
        };
        
        window.app_admin_getUsers = async () => {
            if (!dbUser || dbUser.role !== 'admin') return [];
            const snapshot = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', USERS_COL));
            return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        };
        window.app_admin_updateUser = async (docId, newPass) => {
             if (!dbUser || dbUser.role !== 'admin') return;
             await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', USERS_COL, docId), { password: newPass });
        };
        window.app_admin_deleteUser = async (docId) => {
             if (!dbUser || dbUser.role !== 'admin') return;
             await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', USERS_COL, docId));
        };

        initApp();
    </script>
    
    <style>
        :root { --bg: #212529; --card-bg: #343a40; --accent: #c02d47; --text: #f8f9fa; --border: #495057; --radius: 12px; --gap-closed: #000000; }
        body { font-family: "Hiragino Sans", "Noto Sans JP", sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; }
        
        .status-bar { position: fixed; top: 0; left: 0; padding: 4px 10px; font-size: 0.7rem; z-index: 10000; display: flex; align-items: center; gap: 6px; background: rgba(0,0,0,0.5); border-bottom-right-radius: 8px; backdrop-filter: blur(4px); }
        .status-indicator { width: 8px; height: 8px; border-radius: 50%; background: #808080; }
        .status-indicator.connecting { background: #ffc107; box-shadow: 0 0 5px #ffc107; }
        .status-indicator.online { background: #28a745; box-shadow: 0 0 5px #28a745; }
        .status-indicator.offline { background: #dc3545; box-shadow: 0 0 5px #dc3545; }

        header { background: var(--accent); color: #fff; padding: 1rem; font-size: 1.2rem; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; }
        .header-controls { display: flex; gap: 10px; align-items: center; }
        .header-btn { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5); font-size: 0.8rem; padding: 0.3rem 0.8rem; color: white; border-radius: 4px; cursor: pointer; }
        .header-btn:hover { background: rgba(255,255,255,0.3); }
        main { max-width: 900px; margin: 2rem auto; padding: 0 1rem; padding-bottom: 4rem; }
        .card { background: var(--card-bg); border-radius: var(--radius); box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); padding: 1.5rem; margin-bottom: 1.5rem; }
        .card h2 { font-size: 1.3rem; border-left: 6px solid var(--accent); padding-left: 0.5rem; margin-bottom: 1rem; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; }
        th, td { padding: 0.5rem; text-align: left; border-bottom: 1px solid var(--border); }
        th { background: #212529; font-weight: 600; white-space: nowrap; }
        input[type="text"], input[type="password"], input[type="number"], textarea, select { width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid #6c757d; font-size: 1rem; box-sizing: border-box; background-color: #495057; color: var(--text); }
        textarea { resize: vertical; }
        button { background: var(--accent); border: none; color: white; padding: 0.6rem 1.2rem; border-radius: 6px; cursor: pointer; transition: background 0.2s; }
        button:hover { background: #a4253a; }
        button.secondary { background: #6c757d; }
        button.btn-danger { background-color: #dc3545; }
        button.btn-success { background-color: #28a745; }
        .form-grid { display: flex; flex-wrap: wrap; margin: 0 -0.5rem; }
        .form-col { padding: 0 0.5rem; box-sizing: border-box; margin-bottom: 1rem; }
        .col-4 { flex: 0 0 33.33%; max-width: 33.33%; }
        .col-6 { flex: 0 0 50%; max-width: 50%; }
        .col-12 { flex: 0 0 100%; max-width: 100%; }
        .input-group { display: flex; width: 100%; }
        .input-group-text { background: #212529; border: 1px solid #6c757d; padding: 0.5rem 0.75rem; border-radius: 6px 0 0 6px; font-weight: 600; color: #ced4da; white-space: nowrap; display: flex; align-items: center;}
        .input-group input, .input-group select { border-radius: 0 6px 6px 0; }
        
        .password-wrapper { position: relative; width: 100%; }
        .password-toggle { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; width: 20px; height: 20px; z-index: 10; opacity: 0.7; display: flex; align-items: center; justify-content: center; }
        .password-toggle:hover { opacity: 1; }
        .password-toggle svg { fill: #f8f9fa; width: 100%; height: 100%; }

        .drag-drop-area { border: 2px dashed #ffffff !important; border-radius: var(--radius); padding: 1.5rem 1rem; text-align: center; color: #ffffff !important; cursor: pointer; transition: all 0.2s ease; background: rgba(255, 255, 255, 0.05); }
        .img-preview-box img { max-width: 100%; max-height: 300px; object-fit: contain; }

        .skill-container { display: flex; flex-wrap: wrap; gap: 1rem; }
        .skill-grid-wrapper { flex: 3; min-width: 300px; }
        .acquired-skills-wrapper { flex: 2; min-width: 250px; }
        #skillGrid th.spacer-col-header:hover { background-color: #444; }
        .gap-closed { background-color: #000 !important; }
        #skillGridBody td.selected { background-color: #ffee7c; color: #333; font-weight: bold; }
        #skillGridBody td.judging { background-color: #6c757d; font-weight: bold; }
        
        /* åˆ¤å®šçµæœã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .judgment-result { font-size: 0.9em; margin-left: 10px; }
        
        /* èªè¨¼ç”»é¢ã®ã‚¹ã‚¿ã‚¤ãƒ«ä¿®æ­£ (å³å¯„ã›ãƒœã‚¿ãƒ³åŒ–) */
        .auth-container { max-width: 400px; margin: 4rem auto; text-align: center; }
        .auth-toggle { 
            margin-top: 1rem; 
            color: #fff; 
            cursor: pointer; 
            display: table; /* ä¸­èº«ã«åˆã‚ã›ã¦ä¼¸ç¸® */
            margin-left: auto; /* å³å¯„ã› */
            background-color: #6c757d; /* ãƒœã‚¿ãƒ³é¢¨ã®èƒŒæ™¯ */
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-size: 0.9rem;
            text-decoration: none;
            transition: background 0.2s;
        }
        .auth-toggle:hover { background-color: #5a6268; }

        .auth-note { text-align: left; font-size: 0.8rem; color: #ffaAAA; margin-bottom: 10px; }
        
        .char-item { display: flex; background: var(--card-bg); border-radius: var(--radius); padding: 1rem; align-items: center; gap: 1rem; }
        .char-thumb { width: 120px; height: 120px; border-radius: 6px; object-fit: contain; }
        .char-info { flex-grow: 1; }
        .dynamic-table-container { overflow-x: auto; scrollbar-width: none; }
        
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal { background: var(--card-bg); padding: 2rem; border-radius: var(--radius); max-width: 400px; width: 90%; text-align: center; }
        .modal-buttons { margin-top: 1.5rem; display: flex; justify-content: center; gap: 1rem; }
        .toast-notification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: rgba(50, 50, 50, 0.9); color: #fff; padding: 12px 24px; border-radius: 30px; z-index: 2000; opacity: 0; transition: 0.3s; pointer-events: none; }
        .toast-notification.show { opacity: 1; }
        
        .hidden { display: none !important; }
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #212529; z-index: 9999; display: flex; justify-content: center; align-items: center; color: white; font-size: 1.5rem; flex-direction: column; gap: 10px; }

        /* é–²è¦§ãƒ¢ãƒ¼ãƒ‰æ™‚ã« .edit-only ã‚¯ãƒ©ã‚¹ã‚’æŒã¤è¦ç´ ã‚’å¼·åˆ¶çš„ã«éè¡¨ç¤ºã«ã™ã‚‹ */
        body.view-mode .edit-only { display: none !important; }

        @media (max-width: 700px) {
            .col-4, .col-6 { flex: 0 0 100%; max-width: 100%; }
            .char-item { flex-direction: column; text-align: center; }
            .char-actions { justify-content: center; width: 100%; }
        }
    </style>
</head>
<body>

<div class="status-bar">
    <div id="serverStatus" class="status-indicator connecting"></div>
    <div id="serverStatusText">æ¥ç¶šä¸­...</div>
</div>

<div id="loadingOverlay">
    <div>Server Connecting...</div>
</div>

<!-- Header -->
<header id="appHeader" class="hidden">
    <div id="headerTitle">ã‚·ãƒãƒ“ã‚¬ãƒŸç®¡ç†ã‚µãƒ¼ãƒãƒ¼</div>
    <div class="header-controls">
        <span id="headerUsername" style="font-size:0.9rem; margin-right:10px;"></span>
        <button id="unlockSecretHeaderBtn" class="header-btn hidden" title="ç§˜å¯†ã‚’é–²è¦§">ğŸ”“</button>
        <button id="homeBtn" class="header-btn hidden">ä¸€è¦§</button>
        <button id="adminBtn" class="header-btn hidden">ç®¡ç†</button>
        <button id="loginLinkBtn" class="header-btn hidden" onclick="location.hash='#login'">ãƒ­ã‚°ã‚¤ãƒ³</button>
        <button id="logoutBtn" class="header-btn hidden">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
</header>

<main>
    <!-- === LOGIN SCREEN === -->
    <div id="page-login" class="auth-container hidden">
        <div class="card">
            <h2 id="authTitle">ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°ã‚¤ãƒ³</h2>
            <div class="form-grid">
                <div class="col-12">
                    <input type="text" id="authUsername" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼å">
                </div>
                <div class="col-12">
                    <div class="password-wrapper">
                        <input type="password" id="authPassword" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
                        <span class="password-toggle" id="authPassIcon" onclick="toggleAuthPassword()">
                            <svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
                        </span>
                    </div>
                </div>
                <div id="regReq" class="col-12 hidden">
                    <div class="auth-note">â€»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¦ä»¶: 6æ–‡å­—ä»¥ä¸Š</div>
                </div>
                <div class="col-12" style="margin-top:1rem;">
                    <button id="authActionBtn">ãƒ­ã‚°ã‚¤ãƒ³</button>
                </div>
            </div>
            <!-- åˆ‡æ›¿ãƒœã‚¿ãƒ³ (å³å¯„ã›ãƒ»ãƒœã‚¿ãƒ³åŒ–) -->
            <div class="auth-toggle" id="authToggleBtn">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆã¯ã“ã¡ã‚‰</div>
        </div>
    </div>

    <!-- === ADMIN SCREEN === -->
    <div id="page-admin" class="hidden">
        <div class="card">
            <h2>ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
            <table class="admin-table">
                <thead><tr><th>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th><th>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</th><th>æ“ä½œ</th></tr></thead>
                <tbody id="adminUserListBody"></tbody>
            </table>
        </div>
    </div>

    <!-- === LIST SCREEN === -->
    <div id="page-list" class="hidden">
        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åã§æ¤œç´¢...">
        </div>
        <div style="text-align: right; margin-bottom: 1rem;">
            <button id="createNewBtn">æ–°è¦ä½œæˆ</button>
        </div>
        <div id="charListContainer" class="char-list"></div>
    </div>

    <!-- === EDIT / VIEW SCREEN === -->
    <div id="page-form" class="hidden">
        <form id="charForm">
            <!-- Basic Info -->
            <div class="card">
                <h2>åŸºæœ¬æƒ…å ±</h2>
                <div class="form-grid">
                    <div class="form-col col-6">
                        <div class="input-group"><span class="input-group-text">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</span><input type="text" name="player"></div>
                    </div>
                    <div class="form-col col-6">
                        <div class="input-group"><span class="input-group-text">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å</span><input type="text" name="name"></div>
                    </div>
                    <div class="form-col col-6">
                        <div class="input-group"><span class="input-group-text">ã‚«ãƒŠ</span><input type="text" name="nameKana"></div>
                    </div>
                    <div class="form-col col-6">
                        <div class="input-group"><span class="input-group-text">ãƒ¬ã‚®ãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</span><input type="text" name="regulation"></div>
                    </div>
                    <div class="form-col col-4">
                        <div class="input-group">
                            <span class="input-group-text">æµæ´¾</span>
                            <input type="text" name="substyle" list="styleList">
                            <datalist id="styleList">
                                <option value="æ–œæ­¯å¿è»"><option value="éé¦¬ç¥æµ"><option value="ãƒã‚°ãƒ¬ãƒ¢ãƒ">
                                <option value="æ¯”è‰¯å‚æ©Ÿé–¢"><option value="ç§ç«‹å¾¡æ–å­¦åœ’"><option value="éš å¿ã®è¡€çµ±">
                            </datalist>
                        </div>
                    </div>
                    <div class="form-col col-4">
                        <div class="input-group"><span class="input-group-text">éšç´š</span><input type="text" name="rank"></div>
                    </div>
                    <div class="form-col col-4">
                        <div class="input-group"><span class="input-group-text">å¹´é½¢/æ€§åˆ¥</span><input type="text" name="age_sex"></div>
                    </div>
                    <div class="form-col col-4">
                        <div class="input-group"><span class="input-group-text">è¡¨ã®é¡”</span><input type="text" name="cover"></div>
                    </div>
                    <div class="form-col col-4">
                        <div class="input-group"><span class="input-group-text">ä¿¡å¿µ</span><input type="text" name="belief"></div>
                    </div>
                     <div class="form-col col-4">
                        <div class="input-group"><span class="input-group-text">åŠŸç¸¾</span><input type="text" name="achievements"></div>
                    </div>
                    <div class="form-col col-12">
                        <textarea name="memo" rows="3" placeholder="ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ¡ãƒ¢..."></textarea>
                    </div>
                    
                    <div class="form-col col-6 edit-only">
                        <div id="dropZone" class="drag-drop-area">
                            <div class="drag-icon">ğŸ“</div>
                            <p>ç”»åƒã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—<br><span style="font-size:0.8rem; color:#ddd;">ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</span></p>
                            <input type="file" id="imgInput" accept="image/*" class="hidden-file-input">
                        </div>
                        <button type="button" id="deleteImageBtn" class="btn-danger" style="width:100%; margin-top:10px; display:none;">ç”»åƒã‚’å‰Šé™¤</button>
                    </div>
                    <div class="form-col col-6">
                        <div class="img-preview-box">
                            <img id="charImage" src="" alt="" style="display:none;">
                        </div>
                    </div>
                    
                    <div class="form-col col-12 edit-only">
                        <div class="input-group">
                            <span class="input-group-text" style="background:#440000; color:#ffdddd;">ç·¨é›†ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</span>
                            <input type="text" name="editPassword" placeholder="è¨­å®šã™ã‚‹ã¨ä»–è€…ã¨ã®å…±æœ‰æ™‚ã«ä½¿ç”¨ã§ãã¾ã™">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Skills -->
            <div class="card">
                <h2>ç‰¹æŠ€</h2>
                <div class="skill-controls">
                    <label><input type="radio" name="mode" value="setting" checked> è¨­å®šï¼ˆç¿’å¾—ï¼‰</label>
                    <label style="margin-left:1rem;"><input type="radio" name="mode" value="judgment"> åˆ¤å®š</label>
                    <span style="float:right; color:#aaa; font-size:0.8rem;">A-Eã‚’ã‚¯ãƒªãƒƒã‚¯ã§ã‚®ãƒ£ãƒƒãƒ—é–‰é–</span>
                </div>
                <div class="skill-container">
                    <div class="skill-grid-wrapper">
                        <table id="skillGrid">
                            <thead>
                                <tr>
                                    <th>å™¨è¡“</th><th class="spacer-col-header" data-gap="0">A</th>
                                    <th>ä½“è¡“</th><th class="spacer-col-header" data-gap="1">B</th>
                                    <th>å¿è¡“</th><th class="spacer-col-header" data-gap="2">C</th>
                                    <th>è¬€è¡“</th><th class="spacer-col-header" data-gap="3">D</th>
                                    <th>æˆ¦è¡“</th><th class="spacer-col-header" data-gap="4">E</th>
                                    <th>å¦–è¡“</th>
                                </tr>
                            </thead>
                            <tbody id="skillGridBody"></tbody>
                        </table>
                    </div>
                    <div class="acquired-skills-wrapper">
                        <table id="acquiredSkillsTable">
                            <thead><tr><th>ç¿’å¾—ç‰¹æŠ€ / åˆ¤å®š</th></tr></thead>
                            <tbody id="acquiredSkillsList"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Ninpo -->
            <div class="card">
                <h2>å¿æ³•</h2>
                <div id="ninpoContainer"></div>
                <button type="button" class="btn-add edit-only" onclick="addDynamicRow('ninpo')">+ å¿æ³•è¿½åŠ </button>
            </div>

            <!-- Background -->
            <div class="card">
                <h2>èƒŒæ™¯</h2>
                <div id="backgroundContainer"></div>
                <button type="button" class="btn-add edit-only" onclick="addDynamicRow('background')">+ èƒŒæ™¯è¿½åŠ </button>
            </div>

             <!-- Person -->
             <div class="card">
                <h2>äººç‰© (æ„Ÿæƒ…ãªã©)</h2>
                <div id="personContainer"></div>
                <button type="button" class="btn-add edit-only" onclick="addDynamicRow('person')">+ äººç‰©è¿½åŠ </button>
            </div>
            
             <!-- Tools -->
             <div class="card">
                <h2>å¿å…·</h2>
                <div id="toolContainer"></div>
                <button type="button" class="btn-add edit-only" onclick="addDynamicRow('tool')">+ å¿å…·è¿½åŠ </button>
            </div>

            <!-- Secrets -->
            <div id="secretCard" class="card hidden">
                <h2>å¥¥ç¾©ãƒ»ç§˜å¯†</h2>
                <div id="secretContent">
                    <h3>å¥¥ç¾©</h3>
                    <div id="ougiContainer"></div>
                    <button type="button" class="btn-add edit-only" onclick="addDynamicRow('ougi')">+ å¥¥ç¾©è¿½åŠ </button>
                    <h3>ç§˜å¯†</h3>
                    <textarea name="secret" rows="5" placeholder="ç§˜å¯†æƒ…å ±ã‚’å…¥åŠ›"></textarea>
                </div>
            </div>

            <div class="card button-area edit-only">
                <button type="button" id="saveBtn">ã‚µãƒ¼ãƒãƒ¼ã«ä¿å­˜ã™ã‚‹</button>
                <button type="button" id="cancelBtn" class="secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </form>
    </div>
</main>

<div id="passwordModal" class="modal-overlay">
    <div class="modal">
        <h3>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›</h3>
        <p>é–²è¦§ã™ã‚‹ã«ã¯ç·¨é›†ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
        <input type="password" id="unlockPassInput" style="margin-bottom:1rem;">
        <div class="modal-buttons">
            <button id="unlockConfirmBtn">è§£é™¤</button>
            <button onclick="document.getElementById('passwordModal').style.display='none'" class="secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </div>
</div>

<div id="deleteModal" class="modal-overlay">
    <div class="modal">
        <h3>è­¦å‘Š</h3>
        <p>ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</p>
        <div class="modal-buttons">
            <button id="deleteConfirmBtn" class="btn-danger">ã¯ã„ã€å‰Šé™¤ã—ã¾ã™</button>
            <button id="deleteCancelBtn" class="secondary">ã„ã„ãˆ</button>
        </div>
    </div>
</div>

<div id="toastNotification" class="toast-notification">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div>

<script>
// --- Constants ---
const SKILL_GRID_DATA=[['çµ¡ç¹°è¡“','é¨ä¹—è¡“','ç”Ÿå­˜è¡“','åŒ»è¡“','å…µç³§è¡“','ç•°å½¢åŒ–'],['ç«è¡“','ç ²è¡“','æ½œä¼è¡“','æ¯’è¡“','é³¥ç£è¡“','å¬å–šè¡“'],['æ°´è¡“','æ‰‹è£å‰£è¡“','éèµ°è¡“','ç½ è¡“','é‡æˆ¦è¡“','æ­»éœŠè¡“'],['é‡è¡“','æ‰‹ç·´','éš è”½è¡“','èª¿æŸ»è¡“','åœ°ã®åˆ©','çµç•Œè¡“'],['ä»•è¾¼ã¿','èº«ä½“æ“è¡“','éš å½¢è¡“','è©è¡“','æ„æ°—','å°è¡“'],['è¡£è£…è¡“','æ­©æ³•','éš å¯†è¡“','å¯¾äººè¡“','ç”¨å…µè¡“','è¨€éœŠè¡“'],['ç¸„è¡“','èµ°æ³•','å¤‰è£…è¡“','éŠèŠ¸','è¨˜æ†¶è¡“','å¹»è¡“'],['ç™»è¡“','é£›è¡“','é¦™è¡“','ä¹ãƒä¸€ã®è¡“','è¦‹æ•µè¡“','ç³è¡“'],['æ‹·å•è¡“','éª¨æ³•è¡“','åˆ†èº«ã®è¡“','å‚€å„¡ã®è¡“','æš—å·è¡“','åƒé‡Œçœ¼ã®è¡“'],['éµè¡“','åˆ€è¡“','éš èªè¡“','æµè¨€ã®è¡“','ä¼é”è¡“','æ†‘ä¾è¡“'],['æ˜å‰Šè¡“','æ€ªåŠ›','ç¬¬å…­æ„Ÿ','çµŒæ¸ˆåŠ›','äººè„ˆ','å‘ªè¡“']];
const EMOTIONS={'+':['å…±æ„Ÿ','å‹æƒ…','æ„›æƒ…','å¿ èª ','æ†§æ†¬','ç‹‚ä¿¡'],'-':['ä¸ä¿¡','æ€’ã‚Š','å¦¬ã¿','ä¾®è”‘','åŠ£ç­‰æ„Ÿ','æ®ºæ„']};
const DYNAMIC_SCHEMAS={ninpo:[{key:'name',placeholder:'å¿æ³•å',width:'20%'},{key:'type',placeholder:'åˆ†é¡',width:'15%',options:['æ”»æ’ƒ','ã‚µãƒãƒ¼ãƒˆ','è£…å‚™']},{key:'gap',placeholder:'é–“åˆ',width:'10%'},{key:'cost',placeholder:'ã‚³ã‚¹ãƒˆ',width:'11%'},{key:'effect',placeholder:'åŠ¹æœ',width:'100%'}],background:[{key:'name',placeholder:'èƒŒæ™¯',width:'20%'},{key:'type',placeholder:'ç¨®åˆ¥',width:'11%',options:['é•·æ‰€','å¼±ç‚¹']},{key:'merit',placeholder:'åŠŸç¸¾ç‚¹',width:'10%'},{key:'effect',placeholder:'åŠ¹æœ',width:'50%'},{key:'page',placeholder:'å‚ç…§p',width:'10%'}],person:[{key:'name',placeholder:'äººç‰©å',width:'30%'},{key:'location',placeholder:'å±…æ‰€',type:'checkbox',width:'6%'},{key:'secret',placeholder:'ç§˜å¯†',type:'checkbox',width:'6%'},{key:'ougi',placeholder:'å¥¥ç¾©',type:'checkbox',width:'6%'},{key:'emotion_type',placeholder:'+/-',width:'10%',options:['+','-'],onchange:'updateEmotionOptions(this)'},{key:'emotion',placeholder:'æ„Ÿæƒ…',width:'20%',options:[]},{key:'note',placeholder:'å‚™è€ƒ',width:'20%'}],tool:[{key:'name',placeholder:'åå‰',width:'30%'},{key:'Quantity',placeholder:'å€‹æ•°',width:'15%'},{key:'MeritPoints',placeholder:'åŠŸç¸¾ç‚¹',width:'15%'},{key:'effect',placeholder:'åŠ¹æœ',width:'40%'}],ougi:[{key:'name',placeholder:'å¥¥ç¾©å',width:'15%'},{key:'type',placeholder:'æŒ‡å®šç‰¹æŠ€',width:'15%'},{key:'type',placeholder:'åŠ¹æœ/å¼·ã¿/å¼±ã¿',width:'30%'},{key:'effect',placeholder:'æ¼”å‡º',width:'30%'}]};

// --- State ---
let currentDocId = null;
let currentMode = 'list';
let gapStates = [false, false, false, false, false];
let acquiredSkills = new Set();
let isRegisterMode = false;
let currentCharacterData = null;

// --- Init ---
document.addEventListener('DOMContentLoaded', () => {
    if (!window.location.hash) window.location.hash = '#login';
    handleHashChange();
});

// --- Routing ---
window.addEventListener('hashchange', handleHashChange);

async function handleHashChange() {
    const hash = window.location.hash.substring(1);
    const [route, paramStr] = hash.split('?');
    const params = new URLSearchParams(paramStr);
    const id = params.get('id');

    ['page-login', 'page-admin', 'page-list', 'page-form'].forEach(pid => document.getElementById(pid).classList.add('hidden'));
    
    const header = document.getElementById('appHeader');
    document.getElementById('unlockSecretHeaderBtn').classList.add('hidden'); 

    if (route === 'login') {
        header.classList.add('hidden');
    } else {
        header.classList.remove('hidden');
        document.getElementById('headerUsername').textContent = window.currentUser ? `User: ${window.currentUser.username}` : 'Guest Mode';
        
        if (window.currentUser) {
            document.getElementById('logoutBtn').classList.remove('hidden');
            document.getElementById('loginLinkBtn').classList.add('hidden');
            document.getElementById('homeBtn').classList.remove('hidden');
            if (window.currentUser.role === 'admin') document.getElementById('adminBtn').classList.remove('hidden');
            else document.getElementById('adminBtn').classList.add('hidden');
        } else {
            document.getElementById('logoutBtn').classList.add('hidden');
            document.getElementById('loginLinkBtn').classList.remove('hidden');
            document.getElementById('homeBtn').classList.add('hidden');
            document.getElementById('adminBtn').classList.add('hidden');
        }
    }

    if (route === 'login') {
        document.getElementById('page-login').classList.remove('hidden');
    } else if (route === 'admin') {
        if (!window.currentUser || window.currentUser.role !== 'admin') { window.location.hash = '#login'; return; }
        document.getElementById('page-admin').classList.remove('hidden');
        loadAdminData();
    } else if (route === 'list' || route === '') {
        if (!window.currentUser) { window.location.hash = '#login'; return; }
        document.getElementById('page-list').classList.remove('hidden');
        loadCharacterList();
    } else if (route === 'edit') {
        if (!window.currentUser) { window.location.hash = '#login'; return; }
        currentMode = 'edit';
        document.getElementById('page-form').classList.remove('hidden');
        document.body.classList.remove('view-mode');
        document.body.classList.add('edit-mode');
        setupFormForEdit(id);
    } else if (route === 'view') {
        currentMode = 'view';
        document.getElementById('page-form').classList.remove('hidden');
        document.body.classList.remove('edit-mode');
        document.body.classList.add('view-mode');
        setupFormForView(id);
    }
    
    // Toggle Edit Mode Elements
    document.querySelectorAll('.edit-only').forEach(el => el.style.display = currentMode === 'edit' ? '' : 'none');
    
    // View Mode Readonly
    const form = document.getElementById('charForm');
    form.querySelectorAll('input, textarea, select').forEach(input => {
        if(input.id === 'searchInput' || input.id === 'unlockPassInput') return;
        input.disabled = (currentMode === 'view');
    });
}

// --- Auth UI Logic ---
document.getElementById('authToggleBtn').addEventListener('click', () => {
    isRegisterMode = !isRegisterMode;
    const title = document.getElementById('authTitle');
    const btn = document.getElementById('authActionBtn');
    const toggle = document.getElementById('authToggleBtn');
    const req = document.getElementById('regReq');
    if (isRegisterMode) {
        title.textContent = "æ–°è¦ç™»éŒ²"; btn.textContent = "ç™»éŒ²ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³"; toggle.textContent = "ãƒ­ã‚°ã‚¤ãƒ³ã¯ã“ã¡ã‚‰"; req.classList.remove('hidden');
    } else {
        title.textContent = "ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°ã‚¤ãƒ³"; btn.textContent = "ãƒ­ã‚°ã‚¤ãƒ³"; toggle.textContent = "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆã¯ã“ã¡ã‚‰"; req.classList.add('hidden');
    }
});

function toggleAuthPassword() {
    const input = document.getElementById('authPassword');
    const icon = document.getElementById('authPassIcon');
    const isPass = input.type === "password";
    input.type = isPass ? "text" : "password";
    
    if (isPass) {
        icon.innerHTML = `<svg viewBox="0 0 24 24"><path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/></svg>`;
    } else {
        icon.innerHTML = `<svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>`;
    }
}
window.toggleAuthPassword = toggleAuthPassword;

document.getElementById('authActionBtn').addEventListener('click', async () => {
    const u = document.getElementById('authUsername').value.trim();
    const p = document.getElementById('authPassword').value.trim();
    if (!u || !p) return showToast("ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    if (isRegisterMode) {
        const res = await window.createUserWithEmailAndPassword(u, p);
        if (res.success) {
            showToast("ç™»éŒ²ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™...");
            const loginRes = await window.signInWithEmailAndPassword(u, p);
            if (loginRes.success) window.location.hash = '#list';
        } else { showToast(res.message); }
    } else {
        const res = await window.signInWithEmailAndPassword(u, p);
        if (res.success) window.location.hash = res.role === 'admin' ? '#admin' : '#list';
        else showToast(res.message);
    }
});
document.getElementById('logoutBtn').addEventListener('click', () => window.app_logout());

// --- Unlock Logic ---
document.getElementById('unlockSecretHeaderBtn').addEventListener('click', () => {
    document.getElementById('unlockPassInput').value = '';
    document.getElementById('passwordModal').style.display = 'flex';
});

document.getElementById('unlockConfirmBtn').addEventListener('click', () => {
    const input = document.getElementById('unlockPassInput').value;
    if (currentCharacterData && input === currentCharacterData.editPassword) {
        document.getElementById('secretCard').classList.remove('hidden');
        document.getElementById('unlockSecretHeaderBtn').classList.add('hidden'); 
        renderDynamicTable('ougi', currentCharacterData.ougi || []);
        document.getElementById('passwordModal').style.display = 'none';
        showToast("ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ã—ã¾ã—ãŸ");
    } else {
        showToast("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™");
    }
});

// --- List Logic ---
async function loadCharacterList() {
    const container = document.getElementById('charListContainer');
    container.innerHTML = '<p class="text-center">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>';
    const chars = await window.app_loadCharacters();
    renderList(chars);
    document.getElementById('searchInput').oninput = (e) => {
        const term = e.target.value.toLowerCase();
        renderList(chars.filter(c => (c.name || '').toLowerCase().includes(term)));
    };
}

function renderList(chars) {
    const container = document.getElementById('charListContainer');
    container.innerHTML = '';
    if (chars.length === 0) { container.innerHTML = '<p class="text-center">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒã„ã¾ã›ã‚“</p>'; return; }
    chars.forEach(char => {
        const item = document.createElement('div');
        item.className = 'char-item';
        const imgSrc = char.image || 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIiBmaWxsPSIjNTU1Ij48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIvPjwvc3ZnPg==';
        item.innerHTML = `
            <img src="${imgSrc}" class="char-thumb">
            <div class="char-info"><div class="char-name">${char.name || 'åç§°æœªè¨­å®š'}</div><div class="char-meta">${char.substyle || '-'} / ${char.player || '-'}</div></div>
            <div class="char-actions">
                <button onclick="location.hash='#edit?id=${char.id}'">ç·¨é›†</button>
                <button onclick="location.hash='#view?id=${char.id}'" class="secondary">é–²è¦§</button>
                <button onclick="confirmDelete('${char.id}')" class="btn-danger">å‰Šé™¤</button>
            </div>
        `;
        container.appendChild(item);
    });
}

// --- Edit/View Form Logic ---
async function setupFormForEdit(id) {
    resetForm();
    if (id) { currentDocId = id; await loadCharacterData(id); }
    else { currentDocId = null; createSkillGrid(); Object.keys(DYNAMIC_SCHEMAS).forEach(key => renderDynamicTable(key, [])); }
}

async function setupFormForView(id) {
    resetForm();
    currentDocId = id;
    await loadCharacterData(id);
}

function resetForm() {
    document.getElementById('charForm').reset();
    document.getElementById('charImage').src = "";
    document.getElementById('charImage').style.display = "none";
    document.getElementById('deleteImageBtn').style.display = "none";
    document.getElementById('acquiredSkillsList').innerHTML = "";
    document.getElementById('secretCard').classList.remove('hidden'); 
    acquiredSkills.clear();
    gapStates = [false, false, false, false, false];
    document.querySelector('input[name="mode"][value="setting"]').checked = true;
    createSkillGrid(); 
}

async function loadCharacterData(id) {
    const data = await window.app_getCharacter(id);
    if (!data) {
        showToast("ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
        if(window.currentUser) window.location.hash = '#list'; else window.location.hash = '#login';
        return;
    }
    currentCharacterData = data;
    
    const isOwner = window.currentUser && (window.currentUser.username === data.owner);
    const isAdmin = window.currentUser && (window.currentUser.role === 'admin');
    const canSeeSecrets = isOwner || isAdmin;
    
    if (canSeeSecrets || currentMode === 'edit') {
        document.getElementById('secretCard').classList.remove('hidden');
        document.getElementById('unlockSecretHeaderBtn').classList.add('hidden');
    } else {
        document.getElementById('secretCard').classList.add('hidden');
        if (data.editPassword) {
            document.getElementById('unlockSecretHeaderBtn').classList.remove('hidden');
        } else {
             document.getElementById('unlockSecretHeaderBtn').classList.add('hidden');
        }
    }

    const form = document.getElementById('charForm');
    Object.keys(data).forEach(key => {
        if (form.elements[key] && key !== 'image' && key !== 'mode') form.elements[key].value = data[key];
    });
    
    if (data.image) {
        document.getElementById('charImage').src = data.image;
        document.getElementById('charImage').style.display = 'block';
        if (currentMode === 'edit') document.getElementById('deleteImageBtn').style.display = 'block';
    }
    
    if (data.gapStates) gapStates = data.gapStates;
    createSkillGrid();
    
    if (data.skills) {
        data.skills.forEach(skill => {
            acquiredSkills.add(skill);
            addSkillToList(skill);
            const cell = document.querySelector(`td[data-skill="${skill}"]`);
            if(cell) cell.classList.add('selected');
        });
    }
    
    Object.keys(DYNAMIC_SCHEMAS).forEach(key => {
        if (key === 'ougi' && !canSeeSecrets && currentMode !== 'edit') {
            document.getElementById('ougiContainer').innerHTML = ''; 
        } else {
            renderDynamicTable(key, data[key] || []);
        }
    });
}

document.getElementById('saveBtn').addEventListener('click', async () => {
    const form = document.getElementById('charForm');
    const formData = {};
    [...form.elements].forEach(el => { if (el.name && el.name !== 'mode') formData[el.name] = el.value; });
    const charImageSrc = document.getElementById('charImage').getAttribute('src');
    formData.image = (charImageSrc && charImageSrc !== window.location.href) ? charImageSrc : "";
    formData.skills = Array.from(acquiredSkills);
    formData.gapStates = gapStates;
    Object.keys(DYNAMIC_SCHEMAS).forEach(key => formData[key] = getDynamicData(key));
    try { await window.app_saveCharacter(currentDocId, formData); showToast("ã‚µãƒ¼ãƒãƒ¼ã«ä¿å­˜ã—ã¾ã—ãŸ"); window.location.hash = '#list'; } catch(e) { showToast("ä¿å­˜å¤±æ•—"); }
});

document.getElementById('createNewBtn').addEventListener('click', () => window.location.hash = '#edit');

// Admin & Delete
async function loadAdminData() {
    const tbody = document.getElementById('adminUserListBody'); tbody.innerHTML = '<tr><td colspan="3">å–å¾—ä¸­...</td></tr>';
    const users = await window.app_admin_getUsers(); tbody.innerHTML = '';
    users.forEach(u => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${u.username} <span style="font-size:0.8rem; color:#aaa;">(${u.role})</span></td><td><input type="text" value="${u.password}" id="pass-${u.id}"></td><td class="admin-controls"><button class="btn-sm btn-success" onclick="adminUpdate('${u.id}')">æ›´æ–°</button>${u.role !== 'admin' ? `<button class="btn-sm btn-danger" onclick="adminDelete('${u.id}')">å‰Šé™¤</button>` : ''}</td>`;
        tbody.appendChild(tr);
    });
}
window.adminUpdate = async (uid) => { await window.app_admin_updateUser(uid, document.getElementById(`pass-${uid}`).value); showToast("æ›´æ–°ã—ã¾ã—ãŸ"); };
window.adminDelete = async (uid) => { if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return; await window.app_admin_deleteUser(uid); loadAdminData(); showToast("å‰Šé™¤ã—ã¾ã—ãŸ"); };

let deleteTargetId = null;
window.confirmDelete = (id) => { deleteTargetId = id; document.getElementById('deleteModal').style.display = 'flex'; };
document.getElementById('deleteConfirmBtn').addEventListener('click', async () => {
    if (deleteTargetId) { try { await window.app_deleteCharacter(deleteTargetId); showToast("å‰Šé™¤ã—ã¾ã—ãŸ"); document.getElementById('deleteModal').style.display = 'none'; loadCharacterList(); } catch(e) { showToast("å‰Šé™¤å¤±æ•—"); } }
});
document.getElementById('deleteCancelBtn').addEventListener('click', () => document.getElementById('deleteModal').style.display = 'none');
document.getElementById('deleteImageBtn').addEventListener('click', () => { document.getElementById('charImage').src=""; document.getElementById('charImage').style.display='none'; document.getElementById('imgInput').value=""; document.getElementById('deleteImageBtn').style.display='none'; });

// Helpers
function createSkillGrid(){const b=document.getElementById('skillGridBody'),h=document.querySelector('#skillGrid thead tr');b.innerHTML='';h.querySelectorAll('.spacer-col-header').forEach(th=>{const i=parseInt(th.dataset.gap);th.classList.toggle('gap-closed',gapStates[i]);th.onclick=()=>toggleGap(i)});for(let i=0;i<11;i++){const r=document.createElement('tr');for(let j=0;j<6;j++){const d=document.createElement('td'),s=SKILL_GRID_DATA[i][j];d.textContent=s;d.dataset.skill=s;d.dataset.y=i;d.dataset.x=j;if(acquiredSkills.has(s))d.classList.add('selected');d.onclick=(e)=>handleSkillClick(e.target);r.appendChild(d);if(j<5){const sp=document.createElement('td');sp.className='spacer-col';if(gapStates[j])sp.classList.add('gap-closed');r.appendChild(sp)}}b.appendChild(r)}}
function toggleGap(i){if(currentMode!=='edit')return;gapStates[i]=!gapStates[i];createSkillGrid()}

function handleSkillClick(c){
    const s=c.dataset.skill;
    // é–²è¦§ãƒ¢ãƒ¼ãƒ‰ã§ã‚‚åˆ¤å®šã‚’è¡Œã†ã‚ˆã†ã«æ¡ä»¶å¤‰æ›´
    if(document.querySelector('input[name="mode"]:checked').value==='setting' && currentMode === 'edit'){
        if(acquiredSkills.has(s)){acquiredSkills.delete(s);c.classList.remove('selected');removeSkillFromList(s)}
        else{acquiredSkills.add(s);c.classList.add('selected');addSkillToList(s)}
    } else {
        // åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ (é–²è¦§æ™‚ã‚‚ã“ã“ã‚’é€šã‚‹)
        performJudgment(parseInt(c.dataset.x),parseInt(c.dataset.y),s);
    }
}

function addSkillToList(s){const l=document.getElementById('acquiredSkillsList');if(document.getElementById('row-'+s))return;const t=document.createElement('tr');t.id='row-'+s;t.innerHTML=`<td style="display:flex; justify-content:space-between;"><span>${s}</span><span class="judgment-result"></span></td>`;l.appendChild(t)}
function removeSkillFromList(s){const r=document.getElementById('row-'+s);if(r)r.remove()}

// ä¿®æ­£ã•ã‚ŒãŸåˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯: å…¨ç¿’å¾—ç‰¹æŠ€ã«å¯¾ã—ã¦è¨ˆç®—ã—ã€æœ€å°å€¤ã®ã¿èµ¤è‰²è¡¨ç¤º
function performJudgment(targetX, targetY, targetName) {
    document.querySelectorAll('.judging').forEach(e=>e.classList.remove('judging'));
    document.querySelectorAll('.judgment-result').forEach(e=> { e.textContent=''; e.style.color=''; e.style.fontWeight=''; });

    const targetCell = document.querySelector(`td[data-skill="${targetName}"]`);
    if(targetCell) targetCell.classList.add('judging');

    if (acquiredSkills.size === 0) return;

    let minCost = Infinity;
    const results = [];

    acquiredSkills.forEach(sourceName => {
        const sourceCell = document.querySelector(`td[data-skill="${sourceName}"]`);
        if (!sourceCell) return;
        
        const sx = parseInt(sourceCell.dataset.x);
        const sy = parseInt(sourceCell.dataset.y);
        
        const distY = Math.abs(targetY - sy);
        let distX = 0;
        const startX = Math.min(targetX, sx);
        const endX = Math.max(targetX, sx);
        
        for (let k = startX; k < endX; k++) {
            distX += 1; 
            if (!gapStates[k]) distX += 1; 
        }
        
        const totalCost = distY + distX;
        if (totalCost < minCost) minCost = totalCost;
        
        results.push({ name: sourceName, cost: totalCost });
    });

    results.forEach(res => {
        const row = document.querySelector(`#row-${res.name} .judgment-result`);
        if (row) {
            const targetVal = 5 + res.cost;
            
            // è¡¨ç¤ºãƒ†ã‚­ã‚¹ãƒˆã®çµ„ã¿ç«‹ã¦ï¼ˆä¿®æ­£ç‚¹ï¼‰
            let text = `2D6>=${targetVal}`;
            if (res.name === targetName) {
                text += ` ï¼ˆåˆ¤å®šï¼š${targetName}ï¼‰`;
            } else {
                text += ` ï¼ˆä»£ç”¨åˆ¤å®šï¼š${res.name}ï¼‰`;
            }
            
            row.textContent = text;
            
            // æœ€å°å€¤ã®ã¿èµ¤è‰²å¼·èª¿
            if (res.cost === minCost) {
                row.style.color = '#ff4444'; 
                row.style.fontWeight = 'bold';
            } else {
                row.style.color = '#888';
                row.style.fontWeight = 'normal';
            }
        }
    });
}

function renderDynamicTable(t,d){const c=document.getElementById(t+'Container');let h=`<div class="dynamic-table-container"><table><tbody id="tbody-${t}">`;d.forEach((r,i)=>h+=createRowHTML(t,r,i));h+=`</tbody></table></div>`;c.innerHTML=h}
function createRowHTML(t,r={},i){const s=DYNAMIC_SCHEMAS[t];let h=`<tr class="dynamic-row" data-idx="${i}">`;s.forEach(f=>{const v=r[f.key]||'';h+=`<td width="${f.width}">`;if(f.key==='effect'){h+=`<textarea class="dyn-input" data-key="${f.key}" placeholder="${f.placeholder}" rows="2">${v}</textarea>`}else if(f.type==='checkbox'){const k=r[f.key]==='true'?'checked':'';h+=`<label style="font-size:0.8rem; cursor:pointer;"><input type="checkbox" class="dyn-input" data-key="${f.key}" ${k}><br>${f.placeholder}</label>`}else if(f.options){let o=f.options;if(f.key==='emotion'){const ct=r['emotion_type']||'+';o=EMOTIONS[ct]}const oc=f.onchange?`onchange="${f.onchange}"`:'';h+=`<select class="dyn-input" data-key="${f.key}" ${oc}>`;o.forEach(op=>{const sl=v===op?'selected':'';h+=`<option value="${op}" ${sl}>${op}</option>`});h+=`</select>`}else{h+=`<input type="text" class="dyn-input" data-key="${f.key}" value="${v}" placeholder="${f.placeholder}">`}h+=`</td>`});h+=`<td width="5%" class="edit-only"><button type="button" class="btn-sm btn-danger" onclick="this.closest('tr').remove()">Ã—</button></td></tr>`;return h}
window.addDynamicRow=t=>{const b=document.getElementById(`tbody-${t}`);b.insertAdjacentHTML('beforeend',createRowHTML(t,{},b.children.length))};
window.updateEmotionOptions=s=>{const r=s.closest('tr'),t=s.value,e=r.querySelector('.dyn-input[data-key="emotion"]');if(e){let h='';EMOTIONS[t].forEach(o=>h+=`<option value="${o}">${o}</option>`);e.innerHTML=h}};
function getDynamicData(t){const b=document.getElementById(`tbody-${t}`),R=[];b.querySelectorAll('tr').forEach(r=>{const d={};r.querySelectorAll('.dyn-input').forEach(i=>{if(i.type==='checkbox')d[i.dataset.key]=i.checked?'true':'false';else d[i.dataset.key]=i.value});R.push(d)});return R}
const dz=document.getElementById('dropZone'),ii=document.getElementById('imgInput');dz.addEventListener('click',()=>ii.click());dz.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('dragover')});dz.addEventListener('dragleave',()=>dz.classList.remove('dragover'));dz.addEventListener('drop',e=>{e.preventDefault();dz.classList.remove('dragover');if(e.dataTransfer.files.length){ii.files=e.dataTransfer.files;handleImage(e.dataTransfer.files[0])}});ii.addEventListener('change',e=>{if(e.target.files[0])handleImage(e.target.files[0])});
function handleImage(f){const r=new FileReader();r.onload=ev=>{const i=new Image();i.onload=()=>{const c=document.createElement('canvas'),M=300;let w=i.width,h=i.height;if(w>h){if(w>M){h*=M/w;w=M}}else{if(h>M){w*=M/h;h=M}}c.width=w;c.height=h;c.getContext('2d').drawImage(i,0,0,w,h);document.getElementById('charImage').src=c.toDataURL('image/png');document.getElementById('charImage').style.display='block';document.getElementById('deleteImageBtn').style.display='block'};i.src=ev.target.result};r.readAsDataURL(f)}
function showToast(m){const t=document.getElementById('toastNotification');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000)}
</script>
</body>
</html>
