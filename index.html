<!DOCTYPE html>
<html lang="ja">

<head>

    <!--
    ‰øÆÊ≠£Áâàv5:
    1. „É≠„Ç∞„Ç§„É≥ÁîªÈù¢„ÅÆÂàáÊõø„É™„É≥„ÇØ„ÇíÂè≥ÂØÑ„Åõ„ÅÆ„Éú„Çø„É≥„Å´Â§âÊõ¥
    2. Âà§ÂÆöÂÄ§„ÅÆË°®Á§∫ÂΩ¢Âºè„Çí„Äå2D6>=X Ôºà‰ª£Áî®Âà§ÂÆöÔºöYYÔºâ„ÄçÁ≠â„Å´Â§âÊõ¥daf
    -->

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Ç∑„Éé„Éì„Ç¨„Éü Web„ÉÑ„Éº„É´ (Firebase Server)</title>

    <!-- Firebase SDKs (v11.6.1) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, addDoc, doc, updateDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =================================================================
        // „ÄêÈáçË¶Å„Äë„Åì„Åì„Å´„ÅÇ„Å™„Åü„ÅÆFirebaseË®≠ÂÆöÊÉÖÂ†±„ÇíË≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ
        // =================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyDITm-Xg2nxtVKEW2ojmnNCMmji8vPdneA",
            authDomain: "sinobigami-7e0a8.firebaseapp.com",
            projectId: "sinobigami-7e0a8",
            storageBucket: "sinobigami-7e0a8.firebasestorage.app",
            messagingSenderId: "990756511964",
            appId: "1:990756511964:web:a5547a5d03c23118c3d419",
            measurementId: "G-QLH854BT56"
        };
        // =================================================================

        const appId = 'my-shinobigami-server';
        let app, auth, db;
        let dbUser = null;
        let firebaseReady = false;

        const USERS_COL = 'users';
        const CHARS_COL = 'characters';

        async function initApp() {
            updateStatus('connecting', '„Çµ„Éº„Éê„ÉºÊé•Á∂ö‰∏≠...');

            if (firebaseConfig.apiKey === "„Åì„Åì„Å´API_KEY„ÇíË≤º„Çä‰ªò„Åë") {
                updateStatus('offline', 'Ë®≠ÂÆö„Ç®„É©„Éº');
                alert("FirebaseË®≠ÂÆö„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ„Ç≥„Éº„Éâ„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                await signInAnonymously(auth);
                await ensureAdminExists();

                firebaseReady = true;
                updateStatus('online', '„Çµ„Éº„Éê„ÉºÊé•Á∂öÂÆå‰∫Ü (Online)');
                document.getElementById('loadingOverlay').style.display = 'none';

                const lastUser = localStorage.getItem('last_username');
                if (lastUser) document.getElementById('authUsername').value = lastUser;

                checkAuth();

            } catch (error) {
                console.error("Firebase Init Error:", error);
                updateStatus('offline', 'Êé•Á∂ö„Ç®„É©„Éº');
                alert("„Éá„Éº„Çø„Éô„Éº„ÇπÊé•Á∂ö„Ç®„É©„Éº: " + error.message);
            }
        }

        function updateStatus(state, msg) {
            const el = document.getElementById('serverStatus');
            const txt = document.getElementById('serverStatusText');
            if (el) {
                txt.textContent = msg;
                el.className = 'status-indicator ' + state;
            }
        }

        async function ensureAdminExists() {
            const adminUser = 'seekerius0017';
            const adminPass = '123456789';
            try {
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', USERS_COL), where('username', '==', adminUser));
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', USERS_COL), {
                        username: adminUser,
                        password: adminPass,
                        role: 'admin',
                        createdAt: Date.now()
                    });
                }
            } catch (e) { console.warn("Admin check failed:", e); }
        }

        function checkAuth() {
            const hash = window.location.hash.substring(1).split('?')[0];
            if (hash === 'view') return;
            if (hash === 'login') return;
            if (!dbUser && (hash === 'edit' || hash === 'admin' || hash === 'list' || hash === '')) {
                window.location.hash = '#login';
            }
        }
        window.addEventListener('hashchange', checkAuth);

        window.app_register = async (username, password) => {
            if (!firebaseReady) return alert("„Çµ„Éº„Éê„ÉºÊé•Á∂ö‰∏≠...");
            if (password.length < 6) return { success: false, message: "„Éë„Çπ„ÉØ„Éº„Éâ„ÅØ6ÊñáÂ≠ó‰ª•‰∏ä„ÅßË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ" };
            try {
                const usersRef = collection(db, 'artifacts', appId, 'public', 'data', USERS_COL);
                const q = query(usersRef, where('username', '==', username));
                const snapshot = await getDocs(q);
                if (!snapshot.empty) return { success: false, message: "„Åù„ÅÆ„É¶„Éº„Ç∂„ÉºÂêç„ÅØÊó¢„Å´‰ΩøÁî®„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ" };

                await addDoc(usersRef, {
                    username: username,
                    password: password,
                    role: 'user',
                    createdAt: Date.now()
                });
                return { success: true };
            } catch (e) { return { success: false, message: "„Ç®„É©„Éº: " + e.message }; }
        };

        window.app_login = async (username, password) => {
            if (!firebaseReady) return alert("„Çµ„Éº„Éê„ÉºÊé•Á∂ö‰∏≠...");
            try {
                const usersRef = collection(db, 'artifacts', appId, 'public', 'data', USERS_COL);
                const q = query(usersRef, where('username', '==', username));
                const snapshot = await getDocs(q);
                if (snapshot.empty) return { success: false, message: "„É¶„Éº„Ç∂„ÉºÂêç„Åæ„Åü„ÅØ„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÈÅï„ÅÑ„Åæ„Åô„ÄÇ" };

                const userDoc = snapshot.docs[0];
                const userData = userDoc.data();

                if (userData.password !== password) return { success: false, message: "„É¶„Éº„Ç∂„ÉºÂêç„Åæ„Åü„ÅØ„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÈÅï„ÅÑ„Åæ„Åô„ÄÇ" };

                dbUser = { id: userDoc.id, ...userData };
                window.currentUser = dbUser;
                localStorage.setItem('last_username', username);

                return { success: true, role: userData.role };
            } catch (e) { return { success: false, message: "„É≠„Ç∞„Ç§„É≥„Ç®„É©„Éº" }; }
        };

        window.app_logout = () => {
            dbUser = null;
            window.currentUser = null;
            window.location.hash = '#login';
        };

        window.app_loadCharacters = async () => {
            if (!dbUser) return [];
            try {
                const colRef = collection(db, 'artifacts', appId, 'public', 'data', CHARS_COL);
                const q = query(colRef, where('owner', '==', dbUser.username));
                const snapshot = await getDocs(q);
                return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (e) { return []; }
        };

        window.app_saveCharacter = async (charId, data) => {
            if (!dbUser) return null;
            try {
                const colRef = collection(db, 'artifacts', appId, 'public', 'data', CHARS_COL);
                const savePayload = { ...data, owner: dbUser.username, updatedAt: Date.now() };
                delete savePayload.id;

                if (charId) {
                    await updateDoc(doc(colRef, charId), savePayload);
                    return charId;
                } else {
                    const docRef = await addDoc(colRef, savePayload);
                    return docRef.id;
                }
            } catch (e) { throw e; }
        };

        window.app_getCharacter = async (charId) => {
            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', CHARS_COL, charId);
                const snap = await getDoc(docRef);
                if (!snap.exists()) return null;
                const data = snap.data();
                return { id: snap.id, ...data };
            } catch (e) { return null; }
        };

        window.app_deleteCharacter = async (charId) => {
            if (!dbUser) return;
            try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', CHARS_COL, charId)); } catch (e) { throw e; }
        };

        window.app_admin_getUsers = async () => {
            if (!dbUser || dbUser.role !== 'admin') return [];
            const snapshot = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', USERS_COL));
            return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        };
        window.app_admin_updateUser = async (docId, newPass) => {
            if (!dbUser || dbUser.role !== 'admin') return;
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', USERS_COL, docId), { password: newPass });
        };
        window.app_admin_deleteUser = async (docId) => {
            if (!dbUser || dbUser.role !== 'admin') return;
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', USERS_COL, docId));
        };

        initApp();
    </script>

    <style>
        :root {
            --bg: #212529;
            --card-bg: #343a40;
            --accent: #c02d47;
            --text: #f8f9fa;
            --border: #495057;
            --radius: 12px;
            --gap-closed: #000000;
        }

        body {
            font-family: "Hiragino Sans", "Noto Sans JP", sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
        }

        .status-bar {
            position: fixed;
            top: 0;
            left: 0;
            padding: 4px 10px;
            font-size: 0.7rem;
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(0, 0, 0, 0.5);
            border-bottom-right-radius: 8px;
            backdrop-filter: blur(4px);
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #808080;
        }

        .status-indicator.connecting {
            background: #ffc107;
            box-shadow: 0 0 5px #ffc107;
        }

        .status-indicator.online {
            background: #28a745;
            box-shadow: 0 0 5px #28a745;
        }

        .status-indicator.offline {
            background: #dc3545;
            box-shadow: 0 0 5px #dc3545;
        }

        header {
            background: var(--accent);
            color: #fff;
            padding: 1rem;
            font-size: 1.2rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .header-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.5);
            font-size: 0.8rem;
            padding: 0.3rem 0.8rem;
            color: white;
            border-radius: 4px;
            cursor: pointer;
        }

        .header-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        main {
            max-width: 900px;
            margin: 2rem auto;
            padding: 0 1rem;
            padding-bottom: 4rem;
        }

        /* Palette Modal Styles */
        .color-palette-header {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: #333;
        }

        .palette-modal-content {
            background-color: #f8f9fa;
            color: #333;
            max-width: 600px;
            width: 95%;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
        }

        .palette-textarea {
            width: 100%;
            height: 300px;
            margin: 1rem 0;
            padding: 0.5rem;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-family: monospace;
            resize: none;
            background: #fff;
            color: #000;
        }

        .palette-actions {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
        }

        .btn-copy {
            background-color: #6c757d;
            color: white;
            border-radius: 20px;
            padding: 0.5rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-dl {
            background-color: #a8e6cf;
            color: #3b7a57;
            border-radius: 20px;
            padding: 0.5rem 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-koma {
            background-color: #d1d8e0;
            color: #4b6584;
            border-radius: 20px;
            padding: 0.5rem 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Changed color to better match image */
        .btn-koma-blue {
            background-color: #a2c2e0;
            color: #1e3799;
            border-radius: 20px;
            padding: 0.5rem 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .card h2 {
            font-size: 1.3rem;
            border-left: 6px solid var(--accent);
            padding-left: 0.5rem;
            margin-bottom: 1rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }

        th,
        td {
            padding: 0.5rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: #212529;
            font-weight: 600;
            white-space: nowrap;
        }

        input[type="text"],
        input[type="password"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 0.5rem;
            border-radius: 6px;
            border: 1px solid #6c757d;
            font-size: 1rem;
            box-sizing: border-box;
            background-color: #495057;
            color: var(--text);
        }

        textarea {
            resize: vertical;
        }

        button {
            background: var(--accent);
            border: none;
            color: white;
            padding: 0.6rem 1.2rem;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }

        button:hover {
            background: #a4253a;
        }

        button.secondary {
            background: #6c757d;
        }

        button.btn-danger {
            background-color: #dc3545;
        }

        button.btn-success {
            background-color: #28a745;
        }

        .form-grid {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -0.5rem;
        }

        .form-col {
            padding: 0 0.5rem;
            box-sizing: border-box;
            margin-bottom: 1rem;
        }

        .col-4 {
            flex: 0 0 33.33%;
            max-width: 33.33%;
        }

        .col-6 {
            flex: 0 0 50%;
            max-width: 50%;
        }

        .col-12 {
            flex: 0 0 100%;
            max-width: 100%;
        }

        .input-group {
            display: flex;
            width: 100%;
        }

        .input-group-text {
            background: #212529;
            border: 1px solid #6c757d;
            padding: 0.5rem 0.75rem;
            border-radius: 6px 0 0 6px;
            font-weight: 600;
            color: #ced4da;
            white-space: nowrap;
            display: flex;
            align-items: center;
        }

        .input-group input,
        .input-group select {
            border-radius: 0 6px 6px 0;
        }

        .password-wrapper {
            position: relative;
            width: 100%;
        }

        .password-toggle {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            width: 20px;
            height: 20px;
            z-index: 10;
            opacity: 0.7;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .password-toggle:hover {
            opacity: 1;
        }

        .password-toggle svg {
            fill: #f8f9fa;
            width: 100%;
            height: 100%;
        }

        .drag-drop-area {
            border: 2px dashed #ffffff !important;
            border-radius: var(--radius);
            padding: 1.5rem 1rem;
            text-align: center;
            color: #ffffff !important;
            cursor: pointer;
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.05);
        }

        .img-preview-box img {
            max-width: 100%;
            max-height: 300px;
            object-fit: contain;
        }

        .skill-container {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .skill-grid-wrapper {
            flex: 3;
            min-width: 300px;
        }

        .acquired-skills-wrapper {
            flex: 2;
            min-width: 250px;
        }

        #skillGrid th.spacer-col-header:hover {
            background-color: #444;
        }

        .gap-closed {
            background-color: #000 !important;
        }

        #skillGridBody td.selected {
            background-color: #ffee7c;
            color: #333;
            font-weight: bold;
        }

        #skillGridBody td.judging {
            background-color: #6c757d;
            font-weight: bold;
        }

        /* Âà§ÂÆöÁµêÊûú„ÅÆ„Çπ„Çø„Ç§„É´ */
        .judgment-result {
            font-size: 0.9em;
            margin-left: 10px;
        }

        /* Ë™çË®ºÁîªÈù¢„ÅÆ„Çπ„Çø„Ç§„É´‰øÆÊ≠£ (Âè≥ÂØÑ„Åõ„Éú„Çø„É≥Âåñ) */
        .auth-container {
            max-width: 400px;
            margin: 4rem auto;
            text-align: center;
        }

        .auth-toggle {
            margin-top: 1rem;
            color: #fff;
            cursor: pointer;
            display: table;
            /* ‰∏≠Ë∫´„Å´Âêà„Çè„Åõ„Å¶‰º∏Á∏Æ */
            margin-left: auto;
            /* Âè≥ÂØÑ„Åõ */
            background-color: #6c757d;
            /* „Éú„Çø„É≥È¢®„ÅÆËÉåÊôØ */
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-size: 0.9rem;
            text-decoration: none;
            transition: background 0.2s;
        }

        .auth-toggle:hover {
            background-color: #5a6268;
        }

        .auth-note {
            text-align: left;
            font-size: 0.8rem;
            color: #ffaAAA;
            margin-bottom: 10px;
        }

        .char-item {
            display: flex;
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 1rem;
            align-items: center;
            gap: 1rem;
        }

        .char-thumb {
            width: 120px;
            height: 120px;
            border-radius: 6px;
            object-fit: contain;
        }

        .char-info {
            flex-grow: 1;
        }

        .dynamic-table-container {
            overflow-x: auto;
            scrollbar-width: none;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        /* Ninpo Card UI */
        .ninpo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .ninpo-card {
            background-color: #343a40;
            border-radius: 12px;
            padding: 1rem;
            position: relative;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            border: 1px solid #495057;
        }

        .ninpo-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.8rem;
            border-bottom: 1px solid #6c757d;
            padding-bottom: 0.5rem;
        }

        .ninpo-title-input {
            font-size: 1.2rem;
            font-weight: bold;
            background: transparent;
            border: none;
            color: #fff;
            width: 100%;
        }

        .ninpo-meta {
            font-size: 0.85rem;
            color: #ccc;
            text-align: right;
            white-space: nowrap;
        }

        .ninpo-row {
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
        }

        .ninpo-label {
            width: 60px;
            font-size: 0.85rem;
            color: #adb5bd;
            flex-shrink: 0;
        }

        .ninpo-input,
        .ninpo-select,
        .ninpo-textarea {
            background: transparent;
            border: none;
            border-bottom: 1px solid #6c757d;
            color: #fff;
            width: 100%;
            padding: 2px 5px;
            border-radius: 0;
        }

        .ninpo-select {
            background-color: #343a40;
            /* Needed for dropdown options visibility */
        }

        .ninpo-textarea {
            resize: none;
            height: 3.5em;
            font-size: 0.9rem;
        }

        .ninpo-delete {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: #dc3545;
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            z-index: 10;
        }

        .btn-ninpo-add {
            width: 100%;
            background-color: #c2185b;
            /* Pinkish Red */
            color: white;
            padding: 0.8rem;
            border-radius: 8px;
            font-weight: bold;
            border: none;
            cursor: pointer;
            text-align: left;
            padding-left: 1.5rem;
        }

        .btn-ninpo-add:hover {
            background-color: #a0134a;
        }



        .modal {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: var(--radius);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .modal-buttons {
            margin-top: 1.5rem;
            display: flex;
            justify-content: center;
            gap: 1rem;
        }

        .toast-notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(50, 50, 50, 0.9);
            color: #fff;
            padding: 12px 24px;
            border-radius: 30px;
            z-index: 2000;
            opacity: 0;
            transition: 0.3s;
            pointer-events: none;
        }

        .toast-notification.show {
            opacity: 1;
        }

        .hidden {
            display: none !important;
        }

        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #212529;
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.5rem;
            flex-direction: column;
            gap: 10px;
        }

        /* Èñ≤Ë¶ß„É¢„Éº„ÉâÊôÇ„Å´ .edit-only „ÇØ„É©„Çπ„ÇíÊåÅ„Å§Ë¶ÅÁ¥†„ÇíÂº∑Âà∂ÁöÑ„Å´ÈùûË°®Á§∫„Å´„Åô„Çã */
        body.view-mode .edit-only {
            display: none !important;
        }

        @media (max-width: 700px) {

            .col-4,
            .col-6 {
                flex: 0 0 100%;
                max-width: 100%;
            }

            .char-item {
                flex-direction: column;
                text-align: center;
            }

            .char-actions {
                justify-content: center;
                width: 100%;
            }
        }
    </style>
</head>

<body>

    <div class="status-bar">
        <div id="serverStatus" class="status-indicator connecting"></div>
        <div id="serverStatusText">Êé•Á∂ö‰∏≠...</div>
    </div>

    <div id="loadingOverlay">
        <div>Server Connecting...</div>
    </div>

    <!-- Header -->
    <header id="appHeader" class="hidden">
        <div id="headerTitle" style="cursor: pointer;" onclick="if(window.currentUser) location.hash='#list';">
            „Ç∑„Éé„Éì„Ç¨„ÉüÁÆ°ÁêÜ„Çµ„Éº„Éê„Éº</div>
        <div class="header-controls">
            <span id="headerUsername" style="font-size:0.9rem; margin-right:10px;"></span>
            <button id="unlockSecretHeaderBtn" class="header-btn hidden" title="ÁßòÂØÜ„ÇíÈñ≤Ë¶ß">üîì</button>
            <button id="homeBtn" class="header-btn hidden" onclick="location.hash='#list'">‰∏ÄË¶ß</button>
            <button id="adminBtn" class="header-btn hidden">ÁÆ°ÁêÜ</button>
            <button id="loginLinkBtn" class="header-btn hidden" onclick="location.hash='#login'">„É≠„Ç∞„Ç§„É≥</button>
            <button id="logoutBtn" class="header-btn hidden">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
        </div>
    </header>

    <main>
        <!-- === LOGIN SCREEN === -->
        <div id="page-login" class="auth-container hidden">
            <div class="card">
                <h2 id="authTitle">„Çµ„Éº„Éê„Éº„É≠„Ç∞„Ç§„É≥</h2>
                <div class="form-grid">
                    <div class="col-12">
                        <input type="text" id="authUsername" placeholder="„É¶„Éº„Ç∂„ÉºÂêç">
                    </div>
                    <div class="col-12">
                        <div class="password-wrapper">
                            <input type="password" id="authPassword" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ">
                            <span class="password-toggle" id="authPassIcon" onclick="toggleAuthPassword()">
                                <svg viewBox="0 0 24 24">
                                    <path
                                        d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z" />
                                </svg>
                            </span>
                        </div>
                    </div>
                    <div id="regReq" class="col-12 hidden">
                        <div class="auth-note">‚Äª„Éë„Çπ„ÉØ„Éº„ÉâË¶Å‰ª∂: 6ÊñáÂ≠ó‰ª•‰∏ä</div>
                    </div>
                    <div class="col-12" style="margin-top:1rem;">
                        <button id="authActionBtn">„É≠„Ç∞„Ç§„É≥</button>
                    </div>
                </div>
                <!-- ÂàáÊõø„Éú„Çø„É≥ (Âè≥ÂØÑ„Åõ„Éª„Éú„Çø„É≥Âåñ) -->
                <div class="auth-toggle" id="authToggleBtn">„Ç¢„Ç´„Ç¶„É≥„Éà‰ΩúÊàê„ÅØ„Åì„Å°„Çâ</div>
            </div>
        </div>

        <!-- === ADMIN SCREEN === -->
        <div id="page-admin" class="hidden">
            <div class="card">
                <h2>ÁÆ°ÁêÜËÄÖ„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</h2>
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>„É¶„Éº„Ç∂„ÉºÂêç</th>
                            <th>„Éë„Çπ„ÉØ„Éº„Éâ</th>
                            <th>Êìç‰Ωú</th>
                        </tr>
                    </thead>
                    <tbody id="adminUserListBody"></tbody>
                </table>
            </div>
        </div>

        <!-- === LIST SCREEN === -->
        <div id="page-list" class="hidden">
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="„Ç≠„É£„É©„ÇØ„Çø„ÉºÂêç„ÅßÊ§úÁ¥¢...">
            </div>
            <div style="text-align: right; margin-bottom: 1rem;">
                <button id="createNewBtn">Êñ∞Ë¶è‰ΩúÊàê</button>
            </div>
            <div id="charListContainer" class="char-list"></div>
        </div>

        <!-- === EDIT / VIEW SCREEN === -->
        <div id="page-form" class="hidden">
            <form id="charForm">
                <!-- Basic Info -->
                <div class="card">
                    <h2>Âü∫Êú¨ÊÉÖÂ†±</h2>
                    <div class="form-grid">
                        <div class="form-col col-6">
                            <div class="input-group"><span class="input-group-text">„Éó„É¨„Ç§„É§„Éº</span><input type="text"
                                    name="player"></div>
                        </div>
                        <div class="form-col col-6">
                            <div class="input-group"><span class="input-group-text">„Ç≠„É£„É©„ÇØ„Çø„ÉºÂêç</span><input type="text"
                                    name="name"></div>
                        </div>
                        <div class="form-col col-6">
                            <div class="input-group"><span class="input-group-text">„Ç´„Éä</span><input type="text"
                                    name="nameKana"></div>
                        </div>
                        <div class="form-col col-6">
                            <div class="input-group"><span class="input-group-text">„É¨„ÇÆ„É•„É¨„Éº„Ç∑„Éß„É≥</span><input type="text"
                                    name="regulation"></div>
                        </div>
                        <div class="form-col col-4">
                            <div class="input-group">
                                <span class="input-group-text">ÊµÅÊ¥æ</span>
                                <input type="text" name="substyle" list="styleList">
                                <datalist id="styleList">
                                    <option value="ÊñúÊ≠ØÂøçËªç">
                                    <option value="ÈûçÈ¶¨Á•ûÊµÅ">
                                    <option value="„Éè„Ç∞„É¨„É¢„Éé">
                                    <option value="ÊØîËâØÂùÇÊ©üÈñ¢">
                                    <option value="ÁßÅÁ´ãÂæ°ÊñéÂ≠¶Âúí">
                                    <option value="Èö†Âøç„ÅÆË°ÄÁµ±">
                                </datalist>
                            </div>
                        </div>
                        <div class="form-col col-4">
                            <div class="input-group"><span class="input-group-text">ÈöéÁ¥ö</span><input type="text"
                                    name="rank"></div>
                        </div>
                        <div class="form-col col-4">
                            <div class="input-group"><span class="input-group-text">Âπ¥ÈΩ¢/ÊÄßÂà•</span><input type="text"
                                    name="age_sex"></div>
                        </div>
                        <div class="form-col col-4">
                            <div class="input-group"><span class="input-group-text">Ë°®„ÅÆÈ°î</span><input type="text"
                                    name="cover"></div>
                        </div>
                        <div class="form-col col-4">
                            <div class="input-group"><span class="input-group-text">‰ø°Âøµ</span><input type="text"
                                    name="belief"></div>
                        </div>
                        <div class="form-col col-4">
                            <div class="input-group"><span class="input-group-text">ÂäüÁ∏æ</span><input type="text"
                                    name="achievements"></div>
                        </div>
                        <div class="form-col col-12">
                            <textarea name="memo" rows="3" placeholder="„Ç≠„É£„É©„ÇØ„Çø„Éº„É°„É¢..."></textarea>
                        </div>

                        <div class="form-col col-6 edit-only">
                            <div id="dropZone" class="drag-drop-area">
                                <div class="drag-icon">üìÅ</div>
                                <p>ÁîªÂÉè„Çí„Éâ„É©„ÉÉ„Ç∞ÔºÜ„Éâ„É≠„ÉÉ„Éó<br><span style="font-size:0.8rem; color:#ddd;">„Åæ„Åü„ÅØ„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÈÅ∏Êäû</span></p>
                                <input type="file" id="imgInput" accept="image/*" class="hidden-file-input">
                            </div>
                            <button type="button" id="deleteImageBtn" class="btn-danger"
                                style="width:100%; margin-top:10px; display:none;">ÁîªÂÉè„ÇíÂâäÈô§</button>
                        </div>
                        <div class="form-col col-6">
                            <div class="img-preview-box">
                                <img id="charImage" src="" alt="" style="display:none;">
                            </div>
                        </div>

                        <div class="form-col col-12 edit-only">
                            <div class="input-group">
                                <span class="input-group-text" style="background:#440000; color:#ffdddd;">Á∑®ÈõÜ„Éë„Çπ„ÉØ„Éº„Éâ</span>
                                <input type="text" name="editPassword" placeholder="Ë®≠ÂÆö„Åô„Çã„Å®‰ªñËÄÖ„Å®„ÅÆÂÖ±ÊúâÊôÇ„Å´‰ΩøÁî®„Åß„Åç„Åæ„Åô">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Skills -->
                <div class="card">
                    <h2>ÁâπÊäÄ</h2>
                    <div class="skill-controls">
                        <label><input type="radio" name="mode" value="setting" checked> Ë®≠ÂÆöÔºàÁøíÂæóÔºâ</label>
                        <label style="margin-left:1rem;"><input type="radio" name="mode" value="judgment"> Âà§ÂÆö</label>
                        <span style="float:right; color:#aaa; font-size:0.8rem;">A-E„Çí„ÇØ„É™„ÉÉ„ÇØ„Åß„ÇÆ„É£„ÉÉ„ÉóÈñâÈéñ</span>
                    </div>
                    <div class="skill-container">
                        <div class="skill-grid-wrapper">
                            <table id="skillGrid">
                                <thead>
                                    <tr>
                                        <th>Âô®Ë°ì</th>
                                        <th class="spacer-col-header" data-gap="0">A</th>
                                        <th>‰ΩìË°ì</th>
                                        <th class="spacer-col-header" data-gap="1">B</th>
                                        <th>ÂøçË°ì</th>
                                        <th class="spacer-col-header" data-gap="2">C</th>
                                        <th>Ë¨ÄË°ì</th>
                                        <th class="spacer-col-header" data-gap="3">D</th>
                                        <th>Êà¶Ë°ì</th>
                                        <th class="spacer-col-header" data-gap="4">E</th>
                                        <th>Â¶ñË°ì</th>
                                    </tr>
                                </thead>
                                <tbody id="skillGridBody"></tbody>
                            </table>
                        </div>
                        <div class="acquired-skills-wrapper">
                            <table id="acquiredSkillsTable">
                                <thead>
                                    <tr>
                                        <th>ÁøíÂæóÁâπÊäÄ / Âà§ÂÆö</th>
                                    </tr>
                                </thead>
                                <tbody id="acquiredSkillsList"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Ninpo -->
                <div class="card">
                    <h2>ÂøçÊ≥ï</h2>
                    <div id="ninpoContainer"></div>
                    <button type="button" class="btn-ninpo-add edit-only" onclick="addDynamicRow('ninpo')">+
                        ÂøçÊ≥ïËøΩÂä†</button>
                </div>

                <!-- Background -->
                <div class="card">
                    <h2>ËÉåÊôØ</h2>
                    <div id="backgroundContainer"></div>
                    <button type="button" class="btn-add edit-only" onclick="addDynamicRow('background')">+
                        ËÉåÊôØËøΩÂä†</button>
                </div>

                <!-- Person -->
                <div class="card">
                    <h2>‰∫∫Áâ© (ÊÑüÊÉÖ„Å™„Å©)</h2>
                    <div id="personContainer"></div>
                    <button type="button" class="btn-add edit-only" onclick="addDynamicRow('person')">+ ‰∫∫Áâ©ËøΩÂä†</button>
                </div>

                <!-- Tools -->
                <div class="card">
                    <h2>ÂøçÂÖ∑</h2>
                    <div id="toolContainer"></div>
                    <button type="button" class="btn-add edit-only" onclick="addDynamicRow('tool')">+ ÂøçÂÖ∑ËøΩÂä†</button>
                </div>

                <!-- Secrets -->
                <div id="secretCard" class="card hidden">
                    <h2>Â••Áæ©„ÉªÁßòÂØÜ</h2>
                    <div id="secretContent">
                        <h3>Â••Áæ©</h3>
                        <div id="ougiContainer"></div>
                        <button type="button" class="btn-add edit-only" onclick="addDynamicRow('ougi')">+ Â••Áæ©ËøΩÂä†</button>
                        <h3>ÁßòÂØÜ</h3>
                        <textarea name="secret" rows="5" placeholder="ÁßòÂØÜÊÉÖÂ†±„ÇíÂÖ•Âäõ"></textarea>
                    </div>
                </div>

                <div class="card button-area edit-only">
                    <button type="button" id="saveBtn">„Çµ„Éº„Éê„Éº„Å´‰øùÂ≠ò„Åô„Çã</button>
                    <button type="button" id="cancelBtn" class="secondary">„Ç≠„É£„É≥„Çª„É´</button>
                </div>
            </form>
        </div>
    </main>

    <div id="passwordModal" class="modal-overlay">
        <div class="modal">
            <h3>„Éë„Çπ„ÉØ„Éº„ÉâÂÖ•Âäõ</h3>
            <p>Èñ≤Ë¶ß„Åô„Çã„Å´„ÅØÁ∑®ÈõÜ„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
            <input type="password" id="unlockPassInput" style="margin-bottom:1rem;">
            <div class="modal-buttons">
                <button id="unlockConfirmBtn">Ëß£Èô§</button>
                <button onclick="document.getElementById('passwordModal').style.display='none'"
                    class="secondary">„Ç≠„É£„É≥„Çª„É´</button>
            </div>
        </div>
    </div>

    <div id="deleteModal" class="modal-overlay">
        <div class="modal">
            <h3>Ë≠¶Âëä</h3>
            <p>„Çµ„Éº„Éê„Éº„Åã„ÇâÂÆåÂÖ®„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü</p>
            <div class="modal-buttons">
                <button id="deleteConfirmBtn" class="btn-danger">„ÅØ„ÅÑ„ÄÅÂâäÈô§„Åó„Åæ„Åô</button>
                <button id="deleteCancelBtn" class="secondary">„ÅÑ„ÅÑ„Åà</button>
            </div>
        </div>
    </div>

    <!-- Palette Modal -->
    <div id="paletteModal" class="modal-overlay">
        <div class="palette-modal-content">
            <h3 class="color-palette-header">„ÉÅ„É£„Éë„É¨ÁîüÊàê</h3>
            <p>ÁèæÂú®Ë°®Á§∫‰∏≠„ÅÆ„Ç≠„É£„É©„ÇØ„Çø„Éº„Ç∑„Éº„Éà„Åã„ÇâCCFOLIA„Å™„Å©„ÅßÂà©Áî®„Åß<br>„Åç„Çã„ÉÅ„É£„ÉÉ„Éà„Éë„É¨„ÉÉ„Éà„ÇíÁîüÊàê„Åó„Åæ„Åô</p>
            <h2 id="paletteCharName" style="margin: 1rem 0; color: #333;"></h2>
            <textarea id="paletteText" class="palette-textarea" readonly></textarea>
            <div class="palette-actions">
                <button id="paletteCopyBtn" class="btn-copy">üìã „Ç≥„Éî„Éº</button>
                <button id="paletteDlBtn" class="btn-dl">üì• DL</button>
                <button id="paletteKomaBtn" class="btn-koma-blue">üë§ „Ç≥„ÉûÂá∫Âäõ</button>
            </div>
            <div style="margin-top: 1rem;">
                <button onclick="document.getElementById('paletteModal').style.display='none'"
                    class="secondary">Èñâ„Åò„Çã</button>
            </div>
        </div>
    </div>

    <div id="toastNotification" class="toast-notification">„É°„ÉÉ„Çª„Éº„Ç∏</div>

    <script>
        // --- Constants ---
        const SKILL_GRID_DATA = [['Áµ°Áπ∞Ë°ì', 'È®é‰πóË°ì', 'ÁîüÂ≠òË°ì', 'ÂåªË°ì', 'ÂÖµÁ≥ßË°ì', 'Áï∞ÂΩ¢Âåñ'], ['ÁÅ´Ë°ì', 'Á†≤Ë°ì', 'ÊΩú‰ºèË°ì', 'ÊØíË°ì', 'È≥•Áç£Ë°ì', 'Âè¨ÂñöË°ì'], ['Ê∞¥Ë°ì', 'ÊâãË£èÂâ£Ë°ì', 'ÈÅÅËµ∞Ë°ì', 'ÁΩ†Ë°ì', 'ÈáéÊà¶Ë°ì', 'Ê≠ªÈúäË°ì'], ['ÈáùË°ì', 'ÊâãÁ∑¥', 'Èö†ËîΩË°ì', 'Ë™øÊüªË°ì', 'Âú∞„ÅÆÂà©', 'ÁµêÁïåË°ì'], ['‰ªïËæº„Åø', 'Ë∫´‰ΩìÊìçË°ì', 'Èö†ÂΩ¢Ë°ì', 'Ë©êË°ì', 'ÊÑèÊ∞ó', 'Â∞ÅË°ì'], ['Ë°£Ë£ÖË°ì', 'Ê≠©Ê≥ï', 'Èö†ÂØÜË°ì', 'ÂØæ‰∫∫Ë°ì', 'Áî®ÂÖµË°ì', 'Ë®ÄÈúäË°ì'], ['Á∏ÑË°ì', 'Ëµ∞Ê≥ï', 'Â§âË£ÖË°ì', 'ÈÅäËä∏', 'Ë®òÊÜ∂Ë°ì', 'ÂπªË°ì'], ['ÁôªË°ì', 'È£õË°ì', 'È¶ôË°ì', '‰πù„Éé‰∏Ä„ÅÆË°ì', 'Ë¶ãÊïµË°ì', 'Áû≥Ë°ì'], ['Êã∑ÂïèË°ì', 'È™®Ê≥ïË°ì', 'ÂàÜË∫´„ÅÆË°ì', 'ÂÇÄÂÑ°„ÅÆË°ì', 'ÊöóÂè∑Ë°ì', 'ÂçÉÈáåÁúº„ÅÆË°ì'], ['ÈçµË°ì', 'ÂàÄË°ì', 'Èö†Ë™ûË°ì', 'ÊµÅË®Ä„ÅÆË°ì', '‰ºùÈÅîË°ì', 'ÊÜë‰æùË°ì'], ['ÊéòÂâäË°ì', 'ÊÄ™Âäõ', 'Á¨¨ÂÖ≠ÊÑü', 'ÁµåÊ∏àÂäõ', '‰∫∫ËÑà', 'Âë™Ë°ì']];
        const EMOTIONS = { '+': ['ÂÖ±ÊÑü', 'ÂèãÊÉÖ', 'ÊÑõÊÉÖ', 'Âø†Ë™†', 'ÊÜßÊÜ¨', 'ÁãÇ‰ø°'], '-': ['‰∏ç‰ø°', 'ÊÄí„Çä', 'Â¶¨„Åø', '‰æÆËîë', 'Âä£Á≠âÊÑü', 'ÊÆ∫ÊÑè'] };
        const DYNAMIC_SCHEMAS = { ninpo: [{ key: 'name', placeholder: 'ÂøçÊ≥ïÂêç', width: '16%' }, { key: 'type', placeholder: 'ÂàÜÈ°û', width: '10%', options: ['ÊîªÊíÉ', '„Çµ„Éù„Éº„Éà', 'Ë£ÖÂÇô'] }, { key: 'designated_skill', placeholder: 'ÊåáÂÆöÁâπÊäÄ', width: '14%' }, { key: 'gap', placeholder: 'ÈñìÂêà', width: '8%' }, { key: 'cost', placeholder: '„Ç≥„Çπ„Éà', width: '8%' }, { key: 'effect', placeholder: 'ÂäπÊûú', width: '34%' }, { key: 'page', placeholder: 'ÂèÇÁÖßp', width: '10%' }], background: [{ key: 'name', placeholder: 'ËÉåÊôØ', width: '20%' }, { key: 'type', placeholder: 'Á®ÆÂà•', width: '11%', options: ['Èï∑ÊâÄ', 'Âº±ÁÇπ'] }, { key: 'merit', placeholder: 'ÂäüÁ∏æÁÇπ', width: '10%' }, { key: 'effect', placeholder: 'ÂäπÊûú', width: '50%' }, { key: 'page', placeholder: 'ÂèÇÁÖßp', width: '10%' }], person: [{ key: 'name', placeholder: '‰∫∫Áâ©Âêç', width: '30%' }, { key: 'location', placeholder: 'Â±ÖÊâÄ', type: 'checkbox', width: '6%' }, { key: 'secret', placeholder: 'ÁßòÂØÜ', type: 'checkbox', width: '6%' }, { key: 'ougi', placeholder: 'Â••Áæ©', type: 'checkbox', width: '6%' }, { key: 'emotion_type', placeholder: '+/-', width: '10%', options: ['+', '-'], onchange: 'updateEmotionOptions(this)' }, { key: 'emotion', placeholder: 'ÊÑüÊÉÖ', width: '20%', options: [] }, { key: 'note', placeholder: 'ÂÇôËÄÉ', width: '20%' }], tool: [{ key: 'name', placeholder: 'ÂêçÂâç', width: '30%' }, { key: 'Quantity', placeholder: 'ÂÄãÊï∞', width: '15%' }, { key: 'MeritPoints', placeholder: 'ÂäüÁ∏æÁÇπ', width: '15%' }, { key: 'effect', placeholder: 'ÂäπÊûú', width: '40%' }], ougi: [{ key: 'name', placeholder: 'Â••Áæ©Âêç', width: '15%' }, { key: 'type', placeholder: 'ÊåáÂÆöÁâπÊäÄ', width: '15%' }, { key: 'type', placeholder: 'ÂäπÊûú/Âº∑„Åø/Âº±„Åø', width: '30%' }, { key: 'effect', placeholder: 'ÊºîÂá∫', width: '30%' }] };

        // --- State ---
        let currentDocId = null;
        let currentMode = 'list';
        let gapStates = [false, false, false, false, false];
        let acquiredSkills = new Set();
        let isRegisterMode = false;
        let currentCharacterData = null;

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            if (!window.location.hash) window.location.hash = '#login';
            handleHashChange();
        });

        // --- Routing ---
        window.addEventListener('hashchange', handleHashChange);

        async function handleHashChange() {
            const hash = window.location.hash.substring(1);
            const [route, paramStr] = hash.split('?');
            const params = new URLSearchParams(paramStr);
            const id = params.get('id');

            ['page-login', 'page-admin', 'page-list', 'page-form'].forEach(pid => document.getElementById(pid).classList.add('hidden'));

            const header = document.getElementById('appHeader');
            document.getElementById('unlockSecretHeaderBtn').classList.add('hidden');

            if (route === 'login') {
                header.classList.add('hidden');
            } else {
                header.classList.remove('hidden');
                document.getElementById('headerUsername').textContent = window.currentUser ? `User: ${window.currentUser.username}` : 'Guest Mode';

                if (window.currentUser) {
                    document.getElementById('logoutBtn').classList.remove('hidden');
                    document.getElementById('loginLinkBtn').classList.add('hidden');
                    document.getElementById('homeBtn').classList.remove('hidden');
                    if (window.currentUser.role === 'admin') document.getElementById('adminBtn').classList.remove('hidden');
                    else document.getElementById('adminBtn').classList.add('hidden');
                } else {
                    document.getElementById('logoutBtn').classList.add('hidden');
                    document.getElementById('loginLinkBtn').classList.remove('hidden');
                    document.getElementById('homeBtn').classList.add('hidden');
                    document.getElementById('adminBtn').classList.add('hidden');
                }
            }

            if (route === 'login') {
                document.getElementById('page-login').classList.remove('hidden');
            } else if (route === 'admin') {
                if (!window.currentUser || window.currentUser.role !== 'admin') { window.location.hash = '#login'; return; }
                document.getElementById('page-admin').classList.remove('hidden');
                loadAdminData();
            } else if (route === 'list' || route === '') {
                if (!window.currentUser) { window.location.hash = '#login'; return; }
                document.getElementById('page-list').classList.remove('hidden');
                loadCharacterList();
            } else if (route === 'edit') {
                if (!window.currentUser) { window.location.hash = '#login'; return; }
                currentMode = 'edit';
                document.getElementById('page-form').classList.remove('hidden');
                document.body.classList.remove('view-mode');
                document.body.classList.add('edit-mode');
                setupFormForEdit(id);
            } else if (route === 'view') {
                currentMode = 'view';
                document.getElementById('page-form').classList.remove('hidden');
                document.body.classList.remove('edit-mode');
                document.body.classList.add('view-mode');
                setupFormForView(id);
            }

            // Toggle Edit Mode Elements
            document.querySelectorAll('.edit-only').forEach(el => el.style.display = currentMode === 'edit' ? '' : 'none');

            // View Mode Readonly
            const form = document.getElementById('charForm');
            form.querySelectorAll('input, textarea, select').forEach(input => {
                if (input.id === 'searchInput' || input.id === 'unlockPassInput') return;
                input.disabled = (currentMode === 'view');
            });
        }

        // --- Auth UI Logic ---
        document.getElementById('authToggleBtn').addEventListener('click', () => {
            isRegisterMode = !isRegisterMode;
            const title = document.getElementById('authTitle');
            const btn = document.getElementById('authActionBtn');
            const toggle = document.getElementById('authToggleBtn');
            const req = document.getElementById('regReq');
            if (isRegisterMode) {
                title.textContent = "Êñ∞Ë¶èÁôªÈå≤"; btn.textContent = "ÁôªÈå≤„Åó„Å¶„É≠„Ç∞„Ç§„É≥"; toggle.textContent = "„É≠„Ç∞„Ç§„É≥„ÅØ„Åì„Å°„Çâ"; req.classList.remove('hidden');
            } else {
                title.textContent = "„Çµ„Éº„Éê„Éº„É≠„Ç∞„Ç§„É≥"; btn.textContent = "„É≠„Ç∞„Ç§„É≥"; toggle.textContent = "„Ç¢„Ç´„Ç¶„É≥„Éà‰ΩúÊàê„ÅØ„Åì„Å°„Çâ"; req.classList.add('hidden');
            }
        });

        function toggleAuthPassword() {
            const input = document.getElementById('authPassword');
            const icon = document.getElementById('authPassIcon');
            const isPass = input.type === "password";
            input.type = isPass ? "text" : "password";

            if (isPass) {
                icon.innerHTML = `<svg viewBox="0 0 24 24"><path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/></svg>`;
            } else {
                icon.innerHTML = `<svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>`;
            }
        }
        window.toggleAuthPassword = toggleAuthPassword;

        document.getElementById('authActionBtn').addEventListener('click', async () => {
            const u = document.getElementById('authUsername').value.trim();
            const p = document.getElementById('authPassword').value.trim();
            if (!u || !p) return showToast("„É¶„Éº„Ç∂„ÉºÂêç„Å®„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
            if (isRegisterMode) {
                const res = await window.app_register(u, p);
                if (res.success) {
                    showToast("ÁôªÈå≤„Åó„Åæ„Åó„Åü„ÄÇ„É≠„Ç∞„Ç§„É≥„Åó„Åæ„Åô...");
                    const loginRes = await window.app_login(u, p);
                    if (loginRes.success) window.location.hash = '#list';
                } else { showToast(res.message); }
            } else {
                const res = await window.app_login(u, p);
                if (res.success) window.location.hash = res.role === 'admin' ? '#admin' : '#list';
                else showToast(res.message);
            }
        });
        document.getElementById('logoutBtn').addEventListener('click', () => window.app_logout());

        // --- Unlock Logic ---
        document.getElementById('unlockSecretHeaderBtn').addEventListener('click', () => {
            document.getElementById('unlockPassInput').value = '';
            document.getElementById('passwordModal').style.display = 'flex';
        });

        document.getElementById('unlockConfirmBtn').addEventListener('click', () => {
            const input = document.getElementById('unlockPassInput').value;
            if (currentCharacterData && input === currentCharacterData.editPassword) {
                document.getElementById('secretCard').classList.remove('hidden');
                document.getElementById('unlockSecretHeaderBtn').classList.add('hidden');
                renderDynamicTable('ougi', currentCharacterData.ougi || []);
                document.getElementById('passwordModal').style.display = 'none';
                showToast("„É≠„ÉÉ„ÇØ„ÇíËß£Èô§„Åó„Åæ„Åó„Åü");
            } else {
                showToast("„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÈÅï„ÅÑ„Åæ„Åô");
            }
        });

        // --- List Logic ---
        async function loadCharacterList() {
            const container = document.getElementById('charListContainer');
            container.innerHTML = '<p class="text-center">„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</p>';
            const chars = await window.app_loadCharacters();
            renderList(chars);
            document.getElementById('searchInput').oninput = (e) => {
                const term = e.target.value.toLowerCase();
                renderList(chars.filter(c => (c.name || '').toLowerCase().includes(term)));
            };
        }

        function renderList(chars) {
            const container = document.getElementById('charListContainer');
            container.innerHTML = '';
            if (chars.length === 0) { container.innerHTML = '<p class="text-center">„Ç≠„É£„É©„ÇØ„Çø„Éº„Åå„ÅÑ„Åæ„Åõ„Çì</p>'; return; }
            chars.forEach(char => {
                const item = document.createElement('div');
                item.className = 'char-item';
                const imgSrc = char.image || 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIiBmaWxsPSIjNTU1Ij48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIvPjwvc3ZnPg==';
                item.innerHTML = `
            <img src="${imgSrc}" class="char-thumb">
            <div class="char-info"><div class="char-name">${char.name || 'ÂêçÁß∞Êú™Ë®≠ÂÆö'}</div><div class="char-meta">${char.substyle || '-'} / ${char.player || '-'}</div></div>
            <div class="char-actions">
                <button onclick="location.hash='#edit?id=${char.id}'">Á∑®ÈõÜ</button>
                <button onclick="location.hash='#view?id=${char.id}'" class="secondary">Èñ≤Ë¶ß</button>
                <button onclick="copyCharacter('${char.id}')" class="secondary">„Ç≥„Éî„Éº</button>
                <button onclick="openPalette('${char.id}')" class="secondary">„ÉÅ„É£„ÉÉ„Éà„Éë„É¨„ÉÉ„Éà</button>
                <button onclick="confirmDelete('${char.id}')" class="btn-danger">ÂâäÈô§</button>
            </div>
        `;
                container.appendChild(item);
            });
        }

        // --- Edit/View Form Logic ---
        async function setupFormForEdit(id) {
            resetForm();
            if (id) { currentDocId = id; await loadCharacterData(id); }
            else { currentDocId = null; createSkillGrid(); Object.keys(DYNAMIC_SCHEMAS).forEach(key => renderDynamicTable(key, [])); }
        }

        async function setupFormForView(id) {
            resetForm();
            currentDocId = id;
            await loadCharacterData(id);
        }

        function resetForm() {
            document.getElementById('charForm').reset();
            document.getElementById('charImage').src = "";
            document.getElementById('charImage').style.display = "none";
            document.getElementById('deleteImageBtn').style.display = "none";
            document.getElementById('acquiredSkillsList').innerHTML = "";
            document.getElementById('secretCard').classList.remove('hidden');
            acquiredSkills.clear();
            gapStates = [false, false, false, false, false];
            document.querySelector('input[name="mode"][value="setting"]').checked = true;
            createSkillGrid();
        }

        async function loadCharacterData(id) {
            const data = await window.app_getCharacter(id);
            if (!data) {
                showToast("„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì");
                if (window.currentUser) window.location.hash = '#list'; else window.location.hash = '#login';
                return;
            }
            currentCharacterData = data;

            const isOwner = window.currentUser && (window.currentUser.username === data.owner);
            const isAdmin = window.currentUser && (window.currentUser.role === 'admin');
            const canSeeSecrets = isOwner || isAdmin;

            if (canSeeSecrets || currentMode === 'edit') {
                document.getElementById('secretCard').classList.remove('hidden');
                document.getElementById('unlockSecretHeaderBtn').classList.add('hidden');
            } else {
                document.getElementById('secretCard').classList.add('hidden');
                if (data.editPassword) {
                    document.getElementById('unlockSecretHeaderBtn').classList.remove('hidden');
                } else {
                    document.getElementById('unlockSecretHeaderBtn').classList.add('hidden');
                }
            }

            const form = document.getElementById('charForm');
            Object.keys(data).forEach(key => {
                if (form.elements[key] && key !== 'image' && key !== 'mode') form.elements[key].value = data[key];
            });

            if (data.image) {
                document.getElementById('charImage').src = data.image;
                document.getElementById('charImage').style.display = 'block';
                if (currentMode === 'edit') document.getElementById('deleteImageBtn').style.display = 'block';
            }

            if (data.gapStates) gapStates = data.gapStates;
            createSkillGrid();

            if (data.skills) {
                data.skills.forEach(skill => {
                    acquiredSkills.add(skill);
                    addSkillToList(skill);
                    const cell = document.querySelector(`td[data-skill="${skill}"]`);
                    if (cell) cell.classList.add('selected');
                });
            }

            Object.keys(DYNAMIC_SCHEMAS).forEach(key => {
                if (key === 'ougi' && !canSeeSecrets && currentMode !== 'edit') {
                    document.getElementById('ougiContainer').innerHTML = '';
                } else {
                    renderDynamicTable(key, data[key] || []);
                }
            });
        }

        document.getElementById('saveBtn').addEventListener('click', async () => {
            // ÂøçÊ≥ï„Éê„É™„Éá„Éº„Ç∑„Éß„É≥
            const ninpoData = getDynamicData('ninpo');
            for (const n of ninpoData) {
                if (!n.gap || !n.cost || !n.designated_skill) {
                    showToast("ÂøçÊ≥ï„ÅÆÊåáÂÆöÁâπÊäÄ„ÄÅÈñìÂêà„ÄÅ„Ç≥„Çπ„Éà„ÅØÂøÖÈ†à„Åß„Åô");
                    return;
                }
            }
            const form = document.getElementById('charForm');
            const formData = {};
            [...form.elements].forEach(el => { if (el.name && el.name !== 'mode') formData[el.name] = el.value; });
            const charImageSrc = document.getElementById('charImage').getAttribute('src');
            formData.image = (charImageSrc && charImageSrc !== window.location.href) ? charImageSrc : "";
            formData.skills = Array.from(acquiredSkills);
            formData.gapStates = gapStates;
            Object.keys(DYNAMIC_SCHEMAS).forEach(key => formData[key] = getDynamicData(key));
            try { await window.app_saveCharacter(currentDocId, formData); showToast("„Çµ„Éº„Éê„Éº„Å´‰øùÂ≠ò„Åó„Åæ„Åó„Åü"); window.location.hash = '#list'; } catch (e) { showToast("‰øùÂ≠òÂ§±Êïó"); }
        });

        document.getElementById('createNewBtn').addEventListener('click', () => window.location.hash = '#edit');

        // Admin & Delete
        async function loadAdminData() {
            const tbody = document.getElementById('adminUserListBody'); tbody.innerHTML = '<tr><td colspan="3">ÂèñÂæó‰∏≠...</td></tr>';
            const users = await window.app_admin_getUsers(); tbody.innerHTML = '';
            users.forEach(u => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${u.username} <span style="font-size:0.8rem; color:#aaa;">(${u.role})</span></td><td><input type="text" value="${u.password}" id="pass-${u.id}"></td><td class="admin-controls"><button class="btn-sm btn-success" onclick="adminUpdate('${u.id}')">Êõ¥Êñ∞</button>${u.role !== 'admin' ? `<button class="btn-sm btn-danger" onclick="adminDelete('${u.id}')">ÂâäÈô§</button>` : ''}</td>`;
                tbody.appendChild(tr);
            });
        }
        window.adminUpdate = async (uid) => { await window.app_admin_updateUser(uid, document.getElementById(`pass-${uid}`).value); showToast("Êõ¥Êñ∞„Åó„Åæ„Åó„Åü"); };
        window.adminDelete = async (uid) => { if (!confirm("ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")) return; await window.app_admin_deleteUser(uid); loadAdminData(); showToast("ÂâäÈô§„Åó„Åæ„Åó„Åü"); };

        let deleteTargetId = null;
        window.confirmDelete = (id) => { deleteTargetId = id; document.getElementById('deleteModal').style.display = 'flex'; };

        // „Ç≥„Éî„ÉºÊ©üËÉΩ
        window.copyCharacter = async (charId) => {
            try {
                const data = await window.app_getCharacter(charId);
                if (!data) {
                    showToast("„Ç≥„Éî„ÉºÂÖÉ„ÅÆ„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì");
                    return;
                }
                // „Ç≥„Éî„ÉºÁî®„ÅÆ„Éá„Éº„Çø„Çí‰ΩúÊàê
                const copyData = { ...data };
                delete copyData.id; // ID„ÇíÂâäÈô§„Åó„Å¶Êñ∞Ë¶è‰ΩúÊàêÊâ±„ÅÑ„Å´
                copyData.name = (data.name || 'ÂêçÁß∞Êú™Ë®≠ÂÆö') + '„ÅÆ„Ç≥„Éî„Éº';

                await window.app_saveCharacter(null, copyData);
                showToast("„Ç≠„É£„É©„ÇØ„Çø„Éº„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü");
                loadCharacterList(); // ‰∏ÄË¶ß„ÇíÂÜçË™≠„ÅøËæº„Åø
            } catch (e) {
                showToast("„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü");
                console.error(e);
            }
        };
        document.getElementById('deleteConfirmBtn').addEventListener('click', async () => {
            if (deleteTargetId) { try { await window.app_deleteCharacter(deleteTargetId); showToast("ÂâäÈô§„Åó„Åæ„Åó„Åü"); document.getElementById('deleteModal').style.display = 'none'; loadCharacterList(); } catch (e) { showToast("ÂâäÈô§Â§±Êïó"); } }
        });
        document.getElementById('deleteCancelBtn').addEventListener('click', () => document.getElementById('deleteModal').style.display = 'none');
        document.getElementById('deleteImageBtn').addEventListener('click', () => { document.getElementById('charImage').src = ""; document.getElementById('charImage').style.display = 'none'; document.getElementById('imgInput').value = ""; document.getElementById('deleteImageBtn').style.display = 'none'; });

        // Palette Logic
        window.openPalette = async (charId) => {
            try {
                const data = await window.app_getCharacter(charId);
                if (!data) return showToast("„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì");

                document.getElementById('paletteCharName').textContent = data.name || 'ÂêçÁß∞Êú™Ë®≠ÂÆö';
                const text = generatePaletteText(data);
                document.getElementById('paletteText').value = text;
                document.getElementById('paletteModal').style.display = 'flex';
            } catch (e) {
                console.error(e);
                showToast("ÁîüÊàê„Ç®„É©„Éº");
            }
        };

        function generatePaletteText(data) {
            let text = `„Ç≠„É£„É©„ÇØ„Çø„ÉºÂêç: ${data.name || ''}\n\n`;
            text += `Ôº†ÂøçÊ≥ï\nÔº†Âà§ÂÆö\n\n`;

            // --- Ninpo ---
            text += `‚îÄ‚îÄ‚îÄÂøçÊ≥ï‚îÄ‚îÄ‚îÄ\n`;
            const ninpo = data.ninpo || [];
            ninpo.forEach((n, idx) => {
                const charCode = String.fromCharCode(97 + idx); // a, b, c...
                text += `„Äê${n.name || ''}„Äë„ÄÄ${n.type || ''}„ÄÄÁâπÊäÄ:„Ää${n.designated_skill || '„Å™„Åó'}„Äã„ÄÄÈñìÂêà:${n.gap || ''}„ÄÄ„Ç≥„Çπ„Éà:${n.cost || ''}„ÄÄÂäπÊûú:${n.effect || ''}„ÄÄ„Éö„Éº„Ç∏:${n.page || ''}„ÄÄÔº†ÂøçÊ≥ï @n @${charCode}\n`;
                if (n.designated_skill && n.designated_skill !== '„Å™„Åó') {
                    // Check if designated skill is acquired
                    const skillName = n.designated_skill;
                    const acquired = data.skills ? data.skills.includes(skillName) : false;
                    let tn = 5;
                    // Note: Calculating correct TN for ninpo requires full skill logic. 
                    // Reuse calculateSkillTN logic if possible, or simplified check.
                    // For now, let's use the robust calculation.
                    const skillRes = calculateSkillTN(skillName, new Set(data.skills || []), data.gapStates || [false, false, false, false, false]);
                    if (skillRes) {
                        if (skillRes.source === skillName) {
                            text += `SG@12#2+0>=${skillRes.tn} (Âà§ÂÆöÔºöÔº†${skillName})Ôºö${n.name} Ôº†Âà§ÂÆö @h @${charCode}\n\n`;
                        } else {
                            text += `SG@12#2+0>=${skillRes.tn} (‰ª£Áî®Âà§ÂÆöÔºö${skillRes.source}„ÄÅÊåáÂÆöÁâπÊäÄÔºöÔº†${skillName})Ôºö${n.name} Ôº†Âà§ÂÆö @h @${charCode}\n\n`;
                        }
                    } else {
                        // Default fallback if skill not found in grid (e.g. custom name)
                        text += `SG@12#2+0>=5 (Âà§ÂÆöÔºöÔº†${skillName})Ôºö${n.name} Ôº†Âà§ÂÆö @h @${charCode}\n\n`;
                    }
                } else {
                    text += `\n`;
                }
            });

            // --- Skills by Category ---
            const SKILL_GRID_DATA = [['Áµ°Áπ∞Ë°ì', 'È®é‰πóË°ì', 'ÁîüÂ≠òË°ì', 'ÂåªË°ì', 'ÂÖµÁ≥ßË°ì', 'Áï∞ÂΩ¢Âåñ'], ['ÁÅ´Ë°ì', 'Á†≤Ë°ì', 'ÊΩú‰ºèË°ì', 'ÊØíË°ì', 'È≥•Áç£Ë°ì', 'Âè¨ÂñöË°ì'], ['Ê∞¥Ë°ì', 'ÊâãË£èÂâ£Ë°ì', 'ÈÅÅËµ∞Ë°ì', 'ÁΩ†Ë°ì', 'ÈáéÊà¶Ë°ì', 'Ê≠ªÈúäË°ì'], ['ÈáùË°ì', 'ÊâãÁ∑¥', 'Èö†ËîΩË°ì', 'Ë™øÊüªË°ì', 'Âú∞„ÅÆÂà©', 'ÁµêÁïåË°ì'], ['‰ªïËæº„Åø', 'Ë∫´‰ΩìÊìçË°ì', 'Èö†ÂΩ¢Ë°ì', 'Ë©êË°ì', 'ÊÑèÊ∞ó', 'Â∞ÅË°ì'], ['Ë°£Ë£ÖË°ì', 'Ê≠©Ê≥ï', 'Èö†ÂØÜË°ì', 'ÂØæ‰∫∫Ë°ì', 'Áî®ÂÖµË°ì', 'Ë®ÄÈúäË°ì'], ['Á∏ÑË°ì', 'Ëµ∞Ê≥ï', 'Â§âË£ÖË°ì', 'ÈÅäËä∏', 'Ë®òÊÜ∂Ë°ì', 'ÂπªË°ì'], ['ÁôªË°ì', 'È£õË°ì', 'È¶ôË°ì', '‰πù„Éé‰∏Ä„ÅÆË°ì', 'Ë¶ãÊïµË°ì', 'Áû≥Ë°ì'], ['Êã∑ÂïèË°ì', 'È™®Ê≥ïË°ì', 'ÂàÜË∫´„ÅÆË°ì', 'ÂÇÄÂÑ°„ÅÆË°ì', 'ÊöóÂè∑Ë°ì', 'ÂçÉÈáåÁúº„ÅÆË°ì'], ['ÈçµË°ì', 'ÂàÄË°ì', 'Èö†Ë™ûË°ì', 'ÊµÅË®Ä„ÅÆË°ì', '‰ºùÈÅîË°ì', 'ÊÜë‰æùË°ì'], ['ÊéòÂâäË°ì', 'ÊÄ™Âäõ', 'Á¨¨ÂÖ≠ÊÑü', 'ÁµåÊ∏àÂäõ', '‰∫∫ËÑà', 'Âë™Ë°ì']];
            const categories = ['Âô®Ë°ì', '‰ΩìË°ì', 'ÂøçË°ì', 'Ë¨ÄË°ì', 'Êà¶Ë°ì', 'Â¶ñË°ì'];

            const acquiredSet = new Set(data.skills || []);
            const gaps = data.gapStates || [false, false, false, false, false];

            categories.forEach((cat, colIdx) => {
                text += `„Äê${cat}ÂàÜÈáé„Äë‚îÄ‚îÄ‚îÄ\n`;
                // Iterate through all 11 rows for this column
                for (let row = 0; row < 11; row++) {
                    const skillName = SKILL_GRID_DATA[row][colIdx];
                    const res = calculateSkillTN(skillName, acquiredSet, gaps);
                    if (res) {
                        if (res.source === skillName) {
                            text += `SG@12#2+0>=${res.tn} (Âà§ÂÆöÔºöÔº†${skillName})\n`;
                        } else {
                            // SG@12#2+0>=[TN] (‰ª£Áî®Âà§ÂÆöÔºö[Source], ÊåáÂÆöÁâπÊäÄÔºöÔº†[Target])
                            text += `SG@12#2+0>=${res.tn} (‰ª£Áî®Âà§ÂÆöÔºö${res.source}„ÄÅÊåáÂÆöÁâπÊäÄÔºöÔº†${skillName})\n`;
                        }
                    }
                }
                text += `\n`;
            });

            // --- Curse / Paralysis ---
            text += `‚îÄ‚îÄ‚îÄÂë™„ÅÑ„Éª„Éû„Éí‚îÄ‚îÄ‚îÄ\n`;
            // Simplified: list all acquired skills for now, split by ninpo/skill if possible but data structure mixes them not easily?
            // Actually ninpo names are in data.ninpo
            const ninpoNames = (data.ninpo || []).map(n => n.name).filter(n => n);
            if (ninpoNames.length) {
                text += `choice[${ninpoNames.join(',')}] Ôº†Âë™„ÅÑÂøçÊ≥ï„É©„É≥„ÉÄ„É†ÈÅ∏Êäû\n\n`;
            }
            // All acquired skills for paralysis
            if (data.skills && data.skills.length) {
                text += `choice[${data.skills.join(',')}] Ôº†„Éû„ÉíÁâπÊäÄ„É©„É≥„ÉÄ„É†ÈÅ∏Êäû\n`;
            }

            // --- Fixed Footer ---
            text += `
2D6
D66
„Éé
„Éò
choice[a,b,c]
ÊÑüÊÉÖ‰øÆÊ≠£„ÄÄ[ÂØæË±°] ‚Üí [ÊÑüÊÉÖ]+
ÊÑüÊÉÖ‰øÆÊ≠£„ÄÄ[ÂØæË±°] ‚Üí [ÊÑüÊÉÖ]-

‚îÄ‚îÄ‚îÄ ÊâãÁï™ÈñãÂßã ‚îÄ‚îÄ‚îÄ

‚îÄ‚îÄ‚îÄ ÊâãÁï™ÁµÇ‰∫Ü ‚îÄ‚îÄ‚îÄ

‚îÄ‚îÄ‚îÄ„É©„É≥„ÉÄ„É†ÁâπÊäÄÊ±∫ÂÆöË°®‚îÄ‚îÄ‚îÄ
RTT„ÄÄ„Äê„É©„É≥„ÉÄ„É†ÁâπÊäÄ„Äë
RTT1„ÄÄ„Äê„É©„É≥„ÉÄ„É†ÁâπÊäÄ(1/Âô®Ë°ì)„Äë
RTT2„ÄÄ„Äê„É©„É≥„ÉÄ„É†ÁâπÊäÄ(2/‰ΩìË°ì)„Äë
RTT3„ÄÄ„Äê„É©„É≥„ÉÄ„É†ÁâπÊäÄ(3/ÂøçË°ì)„Äë
RTT4„ÄÄ„Äê„É©„É≥„ÉÄ„É†ÁâπÊäÄ(4/Ë¨ÄË°ì)„Äë
RTT5„ÄÄ„Äê„É©„É≥„ÉÄ„É†ÁâπÊäÄ(5/Êà¶Ë°ì)„Äë
RTT6„ÄÄ„Äê„É©„É≥„ÉÄ„É†ÁâπÊäÄ(6/Â¶ñË°ì)„Äë
RCT„ÄÄ„Äê„É©„É≥„ÉÄ„É†ÂàÜÈáéË°®„Äë

‚îÄ‚îÄ‚îÄ„ÉÄ„É°„Éº„Ç∏ÁÆóÂá∫‚îÄ‚îÄ‚îÄ
x1 RCT„ÄÄ„ÄêÊé•ËøëÊà¶„ÉÄ„É°„Éº„Ç∏1ÁÇπ„Äë
x2 RCT„ÄÄ„ÄêÊé•ËøëÊà¶„ÉÄ„É°„Éº„Ç∏2ÁÇπ„Äë
x3 RCT„ÄÄ„ÄêÊé•ËøëÊà¶„ÉÄ„É°„Éº„Ç∏3ÁÇπ„Äë
x4 RCT„ÄÄ„ÄêÊé•ËøëÊà¶„ÉÄ„É°„Éº„Ç∏4ÁÇπ„Äë
x1 WT„ÄÄ„ÄêÈõÜÂõ£Êà¶„ÉÄ„É°„Éº„Ç∏1ÁÇπ(ÈÄöÂ∏∏)„Äë
x2 WT„ÄÄ„ÄêÈõÜÂõ£Êà¶„ÉÄ„É°„Éº„Ç∏2ÁÇπ(ÈÄöÂ∏∏)„Äë
x3 WT„ÄÄ„ÄêÈõÜÂõ£Êà¶„ÉÄ„É°„Éº„Ç∏3ÁÇπ(ÈÄöÂ∏∏)„Äë
x1 GWT„ÄÄ„ÄêÈõÜÂõ£Êà¶„ÉÄ„É°„Éº„Ç∏1ÁÇπ(Êà¶ÂõΩ)„Äë
x2 GWT„ÄÄ„ÄêÈõÜÂõ£Êà¶„ÉÄ„É°„Éº„Ç∏2ÁÇπ(Êà¶ÂõΩ)„Äë
x3 GWT„ÄÄ„ÄêÈõÜÂõ£Êà¶„ÉÄ„É°„Éº„Ç∏3ÁÇπ(Êà¶ÂõΩ)„Äë

‚îÄ‚îÄ‚îÄÂêÑÁ®ÆË°®‚îÄ‚îÄ‚îÄ
ET„ÄÄ„ÄêÊÑüÊÉÖË°®„Äë
ST„ÄÄ„Äê„Ç∑„Éº„É≥Ë°®„Äë
FT„ÄÄ„Äê„Éï„Ç°„É≥„Éñ„É´Ë°®„Äë
WT„ÄÄ„ÄêÂ§âË™øË°®„Äë
GWT„ÄÄ„ÄêÊà¶ÂõΩÂ§âË™øË°®„Äë
BT„ÄÄ„ÄêÊà¶Â†¥Ë°®„Äë
BNT„ÄÄ„ÄêÊñ∞Êà¶Â†¥Ë°®„Äë
MT„ÄÄ„ÄêÂ¶ñÈ≠îÂåñ(Áï∞ÂΩ¢Ë°®„ÄÅÂ¶ñÈ≠îÂøçÊ≥ïË°®‰∏ÄÊã¨)„Äë
NMT„ÄÄ„ÄêÂ¶ñÈ≠îÂåñ(Êñ∞Áï∞ÂΩ¢Ë°®Âà©Áî®)„Äë
YWT„ÄÄ„ÄêÂ¶ñË°ìÂ§âË™øÂØæÂøúË°®(Áèæ‰ª£ÔºèÊà¶ÂõΩ)„Äë
OTS„ÄÄ„ÄêÊï∞Â•á„Äë
`;
            return text;
        }

        // Helper: Calculate Target Number logic reuse
        function calculateSkillTN(targetName, acquiredSet, gapStates) {
            // Find target coords
            let tx = -1, ty = -1;
            const SKILL_GRID_DATA = [['Áµ°Áπ∞Ë°ì', 'È®é‰πóË°ì', 'ÁîüÂ≠òË°ì', 'ÂåªË°ì', 'ÂÖµÁ≥ßË°ì', 'Áï∞ÂΩ¢Âåñ'], ['ÁÅ´Ë°ì', 'Á†≤Ë°ì', 'ÊΩú‰ºèË°ì', 'ÊØíË°ì', 'È≥•Áç£Ë°ì', 'Âè¨ÂñöË°ì'], ['Ê∞¥Ë°ì', 'ÊâãË£èÂâ£Ë°ì', 'ÈÅÅËµ∞Ë°ì', 'ÁΩ†Ë°ì', 'ÈáéÊà¶Ë°ì', 'Ê≠ªÈúäË°ì'], ['ÈáùË°ì', 'ÊâãÁ∑¥', 'Èö†ËîΩË°ì', 'Ë™øÊüªË°ì', 'Âú∞„ÅÆÂà©', 'ÁµêÁïåË°ì'], ['‰ªïËæº„Åø', 'Ë∫´‰ΩìÊìçË°ì', 'Èö†ÂΩ¢Ë°ì', 'Ë©êË°ì', 'ÊÑèÊ∞ó', 'Â∞ÅË°ì'], ['Ë°£Ë£ÖË°ì', 'Ê≠©Ê≥ï', 'Èö†ÂØÜË°ì', 'ÂØæ‰∫∫Ë°ì', 'Áî®ÂÖµË°ì', 'Ë®ÄÈúäË°ì'], ['Á∏ÑË°ì', 'Ëµ∞Ê≥ï', 'Â§âË£ÖË°ì', 'ÈÅäËä∏', 'Ë®òÊÜ∂Ë°ì', 'ÂπªË°ì'], ['ÁôªË°ì', 'È£õË°ì', 'È¶ôË°ì', '‰πù„Éé‰∏Ä„ÅÆË°ì', 'Ë¶ãÊïµË°ì', 'Áû≥Ë°ì'], ['Êã∑ÂïèË°ì', 'È™®Ê≥ïË°ì', 'ÂàÜË∫´„ÅÆË°ì', 'ÂÇÄÂÑ°„ÅÆË°ì', 'ÊöóÂè∑Ë°ì', 'ÂçÉÈáåÁúº„ÅÆË°ì'], ['ÈçµË°ì', 'ÂàÄË°ì', 'Èö†Ë™ûË°ì', 'ÊµÅË®Ä„ÅÆË°ì', '‰ºùÈÅîË°ì', 'ÊÜë‰æùË°ì'], ['ÊéòÂâäË°ì', 'ÊÄ™Âäõ', 'Á¨¨ÂÖ≠ÊÑü', 'ÁµåÊ∏àÂäõ', '‰∫∫ËÑà', 'Âë™Ë°ì']];
            for (let y = 0; y < 11; y++) {
                for (let x = 0; x < 6; x++) {
                    if (SKILL_GRID_DATA[y][x] === targetName) { tx = x; ty = y; break; }
                }
                if (tx !== -1) break;
            }
            if (tx === -1) return null; // Skill not found

            if (acquiredSet.has(targetName)) return { tn: 5, source: targetName };
            if (acquiredSet.size === 0) return { tn: 12, source: '„Å™„Åó' }; // No skills

            let minCost = Infinity;
            let bestSource = null;

            acquiredSet.forEach(sourceName => {
                let sx = -1, sy = -1;
                for (let y = 0; y < 11; y++) {
                    for (let x = 0; x < 6; x++) {
                        if (SKILL_GRID_DATA[y][x] === sourceName) { sx = x; sy = y; break; }
                    }
                    if (sx !== -1) break;
                }
                if (sx === -1) return;

                const distY = Math.abs(ty - sy);
                let distX = 0;
                const startX = Math.min(tx, sx);
                const endX = Math.min(Math.max(tx, sx), 5); // Ensure within bounds

                // Count gaps
                for (let k = startX; k < Math.max(tx, sx); k++) {
                    distX += 1;
                    if (!gapStates[k]) distX += 1;
                }
                const totalCost = distY + distX;
                if (totalCost < minCost) {
                    minCost = totalCost;
                    bestSource = sourceName;
                }
            });

            return { tn: 5 + minCost, source: bestSource };
        }

        // Modal Event Listeners
        document.getElementById('paletteCopyBtn').addEventListener('click', async () => {
            const text = document.getElementById('paletteText').value;
            await navigator.clipboard.writeText(text);
            showToast("„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü");
        });
        document.getElementById('paletteDlBtn').addEventListener('click', () => {
            const text = document.getElementById('paletteText').value;
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = (document.getElementById('paletteCharName').textContent || 'character') + '.txt';
            a.click();
            URL.revokeObjectURL(url);
        });
        document.getElementById('paletteKomaBtn').addEventListener('click', () => {
            showToast("Ë®≠ÂÆö„ÅÆ„Åø (Êú™ÂÆüË£Ö)");
        });

        // Helpers
        function createSkillGrid() { const b = document.getElementById('skillGridBody'), h = document.querySelector('#skillGrid thead tr'); b.innerHTML = ''; h.querySelectorAll('.spacer-col-header').forEach(th => { const i = parseInt(th.dataset.gap); th.classList.toggle('gap-closed', gapStates[i]); th.onclick = () => toggleGap(i) }); for (let i = 0; i < 11; i++) { const r = document.createElement('tr'); for (let j = 0; j < 6; j++) { const d = document.createElement('td'), s = SKILL_GRID_DATA[i][j]; d.textContent = s; d.dataset.skill = s; d.dataset.y = i; d.dataset.x = j; if (acquiredSkills.has(s)) d.classList.add('selected'); d.onclick = (e) => handleSkillClick(e.target); r.appendChild(d); if (j < 5) { const sp = document.createElement('td'); sp.className = 'spacer-col'; if (gapStates[j]) sp.classList.add('gap-closed'); r.appendChild(sp) } } b.appendChild(r) } }
        function toggleGap(i) { if (currentMode !== 'edit') return; gapStates[i] = !gapStates[i]; createSkillGrid() }

        function handleSkillClick(c) {
            const s = c.dataset.skill;
            // Èñ≤Ë¶ß„É¢„Éº„Éâ„Åß„ÇÇÂà§ÂÆö„ÇíË°å„ÅÜ„Çà„ÅÜ„Å´Êù°‰ª∂Â§âÊõ¥
            if (document.querySelector('input[name="mode"]:checked').value === 'setting' && currentMode === 'edit') {
                if (acquiredSkills.has(s)) { acquiredSkills.delete(s); c.classList.remove('selected'); removeSkillFromList(s) }
                else { acquiredSkills.add(s); c.classList.add('selected'); addSkillToList(s) }
            } else {
                // Âà§ÂÆö„É≠„Ç∏„ÉÉ„ÇØ (Èñ≤Ë¶ßÊôÇ„ÇÇ„Åì„Åì„ÇíÈÄö„Çã)
                performJudgment(parseInt(c.dataset.x), parseInt(c.dataset.y), s);
            }
        }

        function addSkillToList(s) { const l = document.getElementById('acquiredSkillsList'); if (document.getElementById('row-' + s)) return; const t = document.createElement('tr'); t.id = 'row-' + s; t.innerHTML = `<td style="display:flex; justify-content:space-between;"><span>${s}</span><span class="judgment-result"></span></td>`; l.appendChild(t) }
        function removeSkillFromList(s) { const r = document.getElementById('row-' + s); if (r) r.remove() }

        // ‰øÆÊ≠£„Åï„Çå„ÅüÂà§ÂÆö„É≠„Ç∏„ÉÉ„ÇØ: ÂÖ®ÁøíÂæóÁâπÊäÄ„Å´ÂØæ„Åó„Å¶Ë®àÁÆó„Åó„ÄÅÊúÄÂ∞èÂÄ§„ÅÆ„ÅøËµ§Ëâ≤Ë°®Á§∫
        function performJudgment(targetX, targetY, targetName) {
            document.querySelectorAll('.judging').forEach(e => e.classList.remove('judging'));
            document.querySelectorAll('.judgment-result').forEach(e => { e.textContent = ''; e.style.color = ''; e.style.fontWeight = ''; });

            const targetCell = document.querySelector(`td[data-skill="${targetName}"]`);
            if (targetCell) targetCell.classList.add('judging');

            if (acquiredSkills.size === 0) return;

            let minCost = Infinity;
            const results = [];

            acquiredSkills.forEach(sourceName => {
                const sourceCell = document.querySelector(`td[data-skill="${sourceName}"]`);
                if (!sourceCell) return;

                const sx = parseInt(sourceCell.dataset.x);
                const sy = parseInt(sourceCell.dataset.y);

                const distY = Math.abs(targetY - sy);
                let distX = 0;
                const startX = Math.min(targetX, sx);
                const endX = Math.max(targetX, sx);

                for (let k = startX; k < endX; k++) {
                    distX += 1;
                    if (!gapStates[k]) distX += 1;
                }

                const totalCost = distY + distX;
                if (totalCost < minCost) minCost = totalCost;

                results.push({ name: sourceName, cost: totalCost });
            });

            results.forEach(res => {
                const row = document.querySelector(`#row-${res.name} .judgment-result`);
                if (row) {
                    const targetVal = 5 + res.cost;

                    // Ë°®Á§∫„ÉÜ„Ç≠„Çπ„Éà„ÅÆÁµÑ„ÅøÁ´ã„Å¶Ôºà‰øÆÊ≠£ÁÇπÔºâ
                    let text = `2D6>=${targetVal}`;
                    if (res.name === targetName) {
                        text += ` ÔºàÂà§ÂÆöÔºö${targetName}Ôºâ`;
                    } else {
                        text += ` Ôºà${targetName} ‰ª£Áî®Âà§ÂÆöÔºö${res.name}Ôºâ`;
                    }

                    row.textContent = text;

                    // ÊúÄÂ∞èÂÄ§„ÅÆ„ÅøËµ§Ëâ≤Âº∑Ë™ø
                    if (res.cost === minCost) {
                        row.style.color = '#ff4444';
                        row.style.fontWeight = 'bold';
                    } else {
                        row.style.color = '#888';
                        row.style.fontWeight = 'normal';
                    }
                }
            });
        }

        function renderDynamicTable(t, d) {
            const c = document.getElementById(t + 'Container');
            if (t === 'ninpo') {
                c.innerHTML = `<div class="ninpo-grid" id="tbody-ninpo"></div>`;
                const container = document.getElementById('tbody-ninpo');
                d.forEach((r, i) => container.insertAdjacentHTML('beforeend', createNinpoCardHTML(r, i)));
            } else {
                let h = `<div class="dynamic-table-container"><table><tbody id="tbody-${t}">`;
                d.forEach((r, i) => h += createRowHTML(t, r, i));
                h += `</tbody></table></div>`;
                c.innerHTML = h;
            }
        }

        function createNinpoCardHTML(r = {}, i) {
            const v = (k) => r[k] || '';
            // Ensure options are handled for 'type'
            const typeOptions = ['ÊîªÊíÉ', '„Çµ„Éù„Éº„Éà', 'Ë£ÖÂÇô'];
            let typeSelect = `<select class="dyn-input ninpo-select" data-key="type">`;
            typeOptions.forEach(op => {
                typeSelect += `<option value="${op}" ${v('type') === op ? 'selected' : ''}>${op}</option>`;
            });
            typeSelect += `</select>`;

            return `
             <div class="ninpo-card dynamic-row" data-idx="${i}">
                <button type="button" class="ninpo-delete edit-only" onclick="this.closest('.ninpo-card').remove()">√ó</button>
                <div class="ninpo-header">
                    <div style="flex-grow:1; margin-right:1rem;">
                        <input type="text" class="dyn-input ninpo-title-input" data-key="name" value="${v('name')}" placeholder="ÂøçÊ≥ïÂêç">
                    </div>
                    <div class="ninpo-meta">
                        <span style="display:inline-block;">„Ç≥„Çπ„Éà:<input type="text" class="dyn-input" data-key="cost" value="${v('cost')}" style="width:40px; background:transparent; border:none; color:#ccc; text-align:center;"></span>
                        | 
                        <span style="display:inline-block;">ÈñìÂêà:<input type="text" class="dyn-input" data-key="gap" value="${v('gap')}" style="width:40px; background:transparent; border:none; color:#ccc; text-align:center;"></span>
                    </div>
                </div>
                <div class="ninpo-body">
                    <div class="ninpo-row">
                        <span class="ninpo-label">„Çø„Ç§„Éó:</span>
                        <div style="flex-grow:1;">${typeSelect}</div>
                    </div>
                    <div class="ninpo-row">
                        <span class="ninpo-label">ÊåáÂÆöÁâπÊäÄ:</span>
                        <input type="text" class="dyn-input ninpo-input" data-key="designated_skill" value="${v('designated_skill')}" placeholder="ÊåáÂÆöÁâπÊäÄ">
                    </div>
                    <div class="ninpo-row">
                         <span class="ninpo-label" style="align-self:flex-start; margin-top:5px;">ÂäπÊûú:</span>
                         <textarea class="dyn-input ninpo-textarea" data-key="effect" placeholder="ÂäπÊûú">${v('effect')}</textarea>
                    </div>
                    <div class="ninpo-row">
                        <span class="ninpo-label">ÂèÇÁÖß:</span>
                        <input type="text" class="dyn-input ninpo-input" data-key="page" value="${v('page')}" placeholder="ÂèÇÁÖßp">
                    </div>
                </div>
             </div>`;
        }

        function createRowHTML(t, r = {}, i) { const s = DYNAMIC_SCHEMAS[t]; let h = `<tr class="dynamic-row" data-idx="${i}">`; s.forEach(f => { const v = r[f.key] || ''; h += `<td width="${f.width}">`; if (f.key === 'effect') { h += `<textarea class="dyn-input" data-key="${f.key}" placeholder="${f.placeholder}" rows="2">${v}</textarea>` } else if (f.type === 'checkbox') { const k = r[f.key] === 'true' ? 'checked' : ''; h += `<label style="font-size:0.8rem; cursor:pointer;"><input type="checkbox" class="dyn-input" data-key="${f.key}" ${k}><br>${f.placeholder}</label>` } else if (f.options) { let o = f.options; if (f.key === 'emotion') { const ct = r['emotion_type'] || '+'; o = EMOTIONS[ct] } const oc = f.onchange ? `onchange="${f.onchange}"` : ''; h += `<select class="dyn-input" data-key="${f.key}" ${oc}>`; o.forEach(op => { const sl = v === op ? 'selected' : ''; h += `<option value="${op}" ${sl}>${op}</option>` }); h += `</select>` } else { h += `<input type="text" class="dyn-input" data-key="${f.key}" value="${v}" placeholder="${f.placeholder}">` } h += `</td>` }); h += `<td width="5%" class="edit-only"><button type="button" class="btn-sm btn-danger" onclick="this.closest('tr').remove()">√ó</button></td></tr>`; return h }

        window.addDynamicRow = t => {
            const b = document.getElementById(`tbody-${t}`);
            if (t === 'ninpo') {
                b.insertAdjacentHTML('beforeend', createNinpoCardHTML({}, b.children.length));
                // Re-apply edit-only/disabled state if in view mode (though btn usually hidden)
                if (currentMode === 'view') {
                    const newCard = b.lastElementChild;
                    newCard.querySelectorAll('.edit-only').forEach(e => e.style.display = 'none');
                    newCard.querySelectorAll('input, textarea, select').forEach(e => e.disabled = true);
                }
            } else {
                b.insertAdjacentHTML('beforeend', createRowHTML(t, {}, b.children.length));
            }
        };

        window.updateEmotionOptions = s => { const r = s.closest('tr'), t = s.value, e = r.querySelector('.dyn-input[data-key="emotion"]'); if (e) { let h = ''; EMOTIONS[t].forEach(o => h += `<option value="${o}">${o}</option>`); e.innerHTML = h } };

        function getDynamicData(t) {
            const b = document.getElementById(`tbody-${t}`);
            const R = [];
            // Use .dynamic-row class to match both tr and div.ninpo-card
            const rows = b.getElementsByClassName('dynamic-row');
            Array.from(rows).forEach(r => {
                const d = {};
                r.querySelectorAll('.dyn-input').forEach(i => {
                    if (i.type === 'checkbox') d[i.dataset.key] = i.checked ? 'true' : 'false';
                    else d[i.dataset.key] = i.value
                });
                R.push(d)
            });
            return R
        }
        const dz = document.getElementById('dropZone'), ii = document.getElementById('imgInput'); dz.addEventListener('click', () => ii.click()); dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('dragover') }); dz.addEventListener('dragleave', () => dz.classList.remove('dragover')); dz.addEventListener('drop', e => { e.preventDefault(); dz.classList.remove('dragover'); if (e.dataTransfer.files.length) { ii.files = e.dataTransfer.files; handleImage(e.dataTransfer.files[0]) } }); ii.addEventListener('change', e => { if (e.target.files[0]) handleImage(e.target.files[0]) });
        function handleImage(f) { const r = new FileReader(); r.onload = ev => { const i = new Image(); i.onload = () => { const c = document.createElement('canvas'), M = 300; let w = i.width, h = i.height; if (w > h) { if (w > M) { h *= M / w; w = M } } else { if (h > M) { w *= M / h; h = M } } c.width = w; c.height = h; c.getContext('2d').drawImage(i, 0, 0, w, h); document.getElementById('charImage').src = c.toDataURL('image/png'); document.getElementById('charImage').style.display = 'block'; document.getElementById('deleteImageBtn').style.display = 'block' }; i.src = ev.target.result }; r.readAsDataURL(f) }
        function showToast(m) { const t = document.getElementById('toastNotification'); t.textContent = m; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000) }
    </script>
</body>

</html>